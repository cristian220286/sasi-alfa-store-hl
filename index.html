<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sasi Alfa Store HL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .table-header th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.05em; background-color: #f9fafb; position: sticky; top: 0; z-index: 10; }
        .table-cell { padding: 0.75rem 1rem; font-size: 0.875rem; color: #1f2937; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
        .badge-faltante { background-color: #fee2e2; color: #b91c1c; }
        .badge-sobrante { background-color: #dcfce7; color: #166534; }
        .badge-cuadrado { background-color: #e0e7ff; color: #3730a3; }
        .badge-pendiente { background-color: #fef3c7; color: #92400e; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); width: 90%; max-width: 1024px; text-align: left; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        #auth-section { display: flex; flex-direction: column; gap: 1rem; padding: 2rem; background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); max-width: 400px; margin: 50px auto; }
        #app-content { display: none; }
        #movement-history-list li { border-bottom: 1px solid #e5e7eb; padding: 0.75rem 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8 flex flex-col min-h-screen">

    <div id="toast"></div>
    <div id="myModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><p id="modal-message" class="text-lg font-semibold mb-4"></p><div id="modal-buttons" class="flex justify-center gap-4"></div></div></div>
    <div id="adminLogModal" class="modal"><div class="modal-content"><span class="close-button" id="close-admin-log">&times;</span><h2 class="text-2xl font-bold text-gray-800 mb-4">Log de Movimientos de Auditoría</h2><div class="mb-4"><label for="log-date-picker" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Fecha:</label><input type="date" id="log-date-picker" class="input-field w-full max-w-xs"></div><div class="overflow-x-auto max-h-[70vh]"><table class="w-full"><thead class="table-header"><tr><th>Fecha y Hora</th><th>Tipo</th><th>SKU</th><th>Cantidad</th><th>Responsable</th></tr></thead><tbody id="admin-log-body"></tbody></table></div></div></div>
    <div id="passwordModal" class="modal"><div class="modal-content max-w-sm"><h3 id="password-modal-title" class="text-xl font-bold mb-4"></h3><input type="password" id="password-modal-input" class="input-field" placeholder="Contraseña"><div class="flex justify-end gap-4 mt-4"><button id="password-modal-cancel" class="btn btn-secondary">Cancelar</button><button id="password-modal-confirm" class="btn btn-primary">Confirmar</button></div></div></div>

    <main class="flex-grow">
        <div class="max-w-screen-2xl mx-auto">
            <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
                <div><h1 class="text-3xl font-bold text-gray-800">Sasi Alfa Store HL</h1></div>
                <div class="flex items-center gap-4">
                     <div class="text-gray-600">Usuario: <span id="user-id-display" class="font-semibold text-indigo-700">Cargando...</span></div>
                     <div class="text-gray-600">Contador: <span id="contador-display" class="font-semibold text-teal-700">N/A</span></div>
                    <button id="btn-limpiar-datos" class="btn btn-danger"><i class="fa-solid fa-bomb"></i>Limpiar Datos</button>
                    <button id="btn-logout" class="btn btn-secondary"><i class="fa-solid fa-right-from-bracket"></i>Salir</button>
                </div>
            </header>

            <div id="auth-section">
                <h2>Iniciar Sesión / Registrarse</h2>
                <input type="email" id="auth-email" class="input-field" placeholder="Correo Electrónico" required>
                <input type="password" id="auth-password" class="input-field" placeholder="Contraseña" required>
                <button id="btn-login" class="btn btn-primary">Iniciar Sesión</button>
                <button id="btn-register" class="btn btn-secondary">Registrarse</button>
            </div>

            <div id="app-content">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="card"><h2 class="text-xl font-semibold mb-4 text-gray-700">1. Sesión de Conteo</h2><div class="space-y-4"><input type="text" id="contador-nombre" class="input-field" placeholder="Nombre de quien cuenta"><button id="btn-guardar-contador" class="btn btn-primary w-full bg-teal-600 hover:bg-teal-700"><i class="fa-solid fa-user-check"></i>Fijar Nombre</button></div></div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4 text-gray-700">2. Cargar Catálogo (CSV)</h2><input type="file" id="csv-file-input" accept=".csv" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" disabled><p id="csv-helper" class="text-sm text-gray-500 mt-2">Inicie sesión para activar.</p></div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4 text-gray-700">3. Registrar Venta</h2><form id="form-ventas"><div class="space-y-4"><input type="text" id="venta-sku" class="input-field" placeholder="SKU del Producto" required><input type="number" id="venta-cantidad" class="input-field" placeholder="Cantidad Vendida" required min="1"><button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-cart-shopping"></i>Registrar</button></div></form></div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4 text-gray-700">4. Añadir a Conteo Físico</h2><form id="form-conteo"><div class="space-y-4"><input type="text" id="conteo-sku" class="input-field" placeholder="SKU del Producto" required><input type="number" id="conteo-cantidad" class="input-field" placeholder="Cantidad a AÑADIR" required min="1"><button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-plus"></i>Añadir</button></div></form></div>
                </div>

                <div class="card border-2 border-rose-400 bg-rose-50 mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-rose-800"><i class="fa-solid fa-user-shield"></i> Operaciones de Administrador</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                        <form id="form-correccion-admin">
                            <h3 class="font-semibold text-lg mb-2 text-amber-800"><i class="fa-solid fa-pen-to-square"></i> Corregir Stock Físico</h3>
                            <div class="space-y-3">
                                <input type="text" id="correc-sku" class="input-field" placeholder="SKU a corregir" required>
                                <input type="number" id="correc-cantidad" class="input-field" placeholder="Nuevo Stock Físico TOTAL" required min="0">
                                <input type="email" id="correc-email" class="input-field" placeholder="Su Email para auditoría" required>
                                <input type="password" id="correc-codigo" class="input-field" placeholder="Código de Autorización" required>
                                <button type="submit" class="btn btn-primary w-full bg-amber-600 hover:bg-amber-700">Corregir</button>
                            </div>
                        </form>
                         <form id="form-anulacion">
                            <h3 class="font-semibold text-lg mb-2 text-red-800"><i class="fa-solid fa-undo"></i> Anular Venta</h3>
                            <div class="space-y-3">
                                <input type="text" id="anular-sku" class="input-field" placeholder="SKU de la venta a anular" required>
                                <input type="number" id="anular-cantidad" class="input-field" placeholder="Cantidad a anular" required min="1">
                                <input type="email" id="anular-email" class="input-field" placeholder="Su Email para auditoría" required>
                                <input type="password" id="anular-codigo" class="input-field" placeholder="Código de Autorización" required>
                                <button type="submit" class="btn btn-primary w-full bg-rose-600 hover:bg-rose-700">Anular</button>
                            </div>
                        </form>
                        <form id="form-reposicion-csv">
                            <h3 class="font-semibold text-lg mb-2 text-sky-800"><i class="fa-solid fa-truck-ramp-box"></i> Reponer Stock (CSV)</h3>
                            <div class="space-y-3">
                                <input type="file" id="repo-csv-input" accept=".csv" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100" required>
                                <input type="email" id="repo-email" class="input-field" placeholder="Su Email para auditoría" required>
                                <input type="password" id="repo-codigo" class="input-field" placeholder="Código de Autorización" required>
                                <button type="submit" class="btn btn-primary w-full bg-sky-600 hover:bg-sky-700"><i class="fa-solid fa-dolly"></i>Cargar Reposición</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="card xl:col-span-2">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Últimos 10 SKUs Contados</h2>
                        <div class="overflow-x-auto max-h-[250px]"><table class="w-full"><thead class="table-header"><tr><th>SKU</th><th>Contado Por</th><th>Fecha y Hora</th></tr></thead><tbody id="last-counted-body"></tbody></table></div>
                    </div>
                    <div class="card bg-gray-800 text-white"><h2 class="text-xl font-semibold mb-4"><i class="fa-solid fa-book"></i> Log de Auditoría</h2><p class="text-gray-400 mb-4">Ver todos los movimientos registrados.</p><button id="btn-abrir-log-admin" class="btn btn-primary w-full bg-gray-600 hover:bg-gray-700">Abrir Log</button></div>
                </div>

                <div class="card mt-6">
                    <div class="flex justify-between items-center mb-4 gap-4 flex-wrap"><h2 class="text-2xl font-bold text-gray-800">Dashboard de Reconciliación</h2><div class="flex gap-4 items-center"><input type="text" id="search-input" placeholder="Buscar por SKU..." class="input-field w-full max-w-xs"><button id="btn-descargar-csv" class="btn btn-secondary"><i class="fa-solid fa-file-csv"></i>Descargar CSV</button></div></div>
                    <div class="overflow-x-auto max-h-[65vh]"><table class="w-full"><thead class="table-header"><tr><th>Prioridad</th><th>SKU</th><th>Estado</th><th>Stock Final</th><th>Dif. Conteo</th><th>Físico Contado</th><th>Stock Teórico</th><th>Total Vendido</th><th>Contado por</th><th>Fecha Ing. Teórico</th><th>Fecha Últ. Repo.</th><th>Fecha Conteo</th><th>Fecha Venta</th></tr></thead><tbody id="dashboard-body"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center p-4 text-gray-500 text-sm mt-auto"><p>By Mor</p></footer>

    <script type="module">
        const BUSINESS_ID = 'Sasi Alfa Store HL'; 
        const ADMIN_PASSWORD = '10234567';
        const LOG_PASSWORD = 'P1CL3S';
        const GOOGLE_SCRIPT_URL_AUDIT = 'https://script.google.com/macros/s/AKfycbxIwVvZXxgOSzXqftcVUOoee2TixwQ-bFUpF0lbXFi876H2Mq7SKkZDGb_tTc67fCED/exec';
        const firebaseConfig = {
          apiKey: "AIzaSyAzGc3KVQFYIoQ7W_WZAj585AbUpiU5HUI",
          authDomain: "sasi-alfa-store-pps.firebaseapp.com",
          projectId: "sasi-alfa-store-pps",
          storageBucket: "sasi-alfa-store-pps.firebasestorage.app",
          messagingSenderId: "739926676625",
          appId: "1:739926676625:web:b4ff509e304f980ff71b30"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, query, orderBy, serverTimestamp, writeBatch, getDocs, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let stockTeoricoCol, datosVentasCol, datosConteoCol;
        let stockTeorico = [], datosVentas = [], datosConteo = [];
        let userId = null, userEmail = null;
        let nombreContador = 'N/A';

        const formVentas = document.getElementById('form-ventas');
        const formConteo = document.getElementById('form-conteo');
        const formCorreccionAdmin = document.getElementById('form-correccion-admin');
        const formReposicionCsv = document.getElementById('form-reposicion-csv');
        const formAnulacion = document.getElementById('form-anulacion');
        const dashboardBody = document.getElementById('dashboard-body');
        const lastCountedBody = document.getElementById('last-counted-body');
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const myModal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');
        const passwordModal = document.getElementById('passwordModal');
        const contadorNombreInput = document.getElementById('contador-nombre');
        const btnGuardarContador = document.getElementById('btn-guardar-contador');
        const contadorDisplay = document.getElementById('contador-display');
        const adminLogModal = document.getElementById('adminLogModal');
        const btnAbrirLogAdmin = document.getElementById('btn-abrir-log-admin');
        const logDatePicker = document.getElementById('log-date-picker');
        const adminLogBody = document.getElementById('admin-log-body');
        const searchInput = document.getElementById('search-input');

        function showModal(message) { modalMessage.innerHTML = `<p>${message}</p>`; modalButtons.innerHTML = `<button class="btn btn-primary">Aceptar</button>`; modalButtons.firstElementChild.onclick = () => { myModal.style.display = 'none'; }; myModal.style.display = 'flex'; }
        function showToast(message, isError = false) { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = `show ${isError ? 'error' : 'success'}`; setTimeout(() => { toast.classList.remove('show'); }, 3000); }
        document.querySelector('.close-button').onclick = () => { myModal.style.display = 'none'; };
        document.getElementById('close-admin-log').onclick = () => { adminLogModal.style.display = 'none'; };
        
        function showPasswordModal(title, onConfirm) {
            passwordModal.style.display = 'flex';
            document.getElementById('password-modal-title').textContent = title;
            const input = document.getElementById('password-modal-input');
            input.value = '';
            const confirmBtn = document.getElementById('password-modal-confirm');
            const cancelBtn = document.getElementById('password-modal-cancel');
            const confirmHandler = () => { passwordModal.style.display = 'none'; onConfirm(input.value); cleanup(); };
            const cancelHandler = () => { passwordModal.style.display = 'none'; cleanup(); };
            const cleanup = () => { confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            input.focus();
        }

        const normalizarSku = (sku) => sku ? sku.toUpperCase().trim() : '';
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid; userEmail = user.email;
                document.getElementById('user-id-display').textContent = userEmail || userId;
                authSection.style.display = 'none'; appContent.style.display = 'block';
                stockTeoricoCol = collection(db, `businesses/${BUSINESS_ID}/stockTeorico`);
                datosVentasCol = collection(db, `businesses/${BUSINESS_ID}/datosVentas`);
                datosConteoCol = collection(db, `businesses/${BUSINESS_ID}/datosConteo`);
                document.getElementById('csv-file-input').disabled = false;
                document.getElementById('csv-helper').textContent = 'Seleccione un archivo CSV.';
                setupFirestoreListeners();
            } else {
                userId = null; userEmail = null;
                document.getElementById('user-id-display').textContent = 'No autenticado';
                authSection.style.display = 'flex'; appContent.style.display = 'none';
                stockTeorico = []; datosVentas = []; datosConteo = []; renderAll();
            }
        });

        function setupFirestoreListeners() {
            onSnapshot(query(collection(db, `businesses/${BUSINESS_ID}/stockTeorico`)), s => { stockTeorico = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
            onSnapshot(query(collection(db, `businesses/${BUSINESS_ID}/datosVentas`), orderBy("timestamp", "desc")), s => { datosVentas = s.docs.map(d => ({...d.data(), id: d.id, timestamp: d.data().timestamp })); renderAll(); });
            onSnapshot(query(collection(db, `businesses/${BUSINESS_ID}/datosConteo`), orderBy("timestamp", "desc")), s => { datosConteo = s.docs.map(d => ({...d.data(), id: d.id, timestamp: d.data().timestamp })); renderAll(); });
        }
        
        function renderAll() { 
            const data = getDashboardData();
            renderDashboard(data); 
            document.getElementById('movement-history-list').innerHTML = renderMovementHistory(); 
            renderAdminLog();
            renderLastCounted();
        }

        function getDashboardData() {
            const searchTerm = normalizarSku(searchInput.value);
            let motorCalculos = stockTeorico.map(producto => {
                const sku = producto.sku;
                const stockTeoricoInicial = producto.stock || 0;
                const fechaIngresoTeorico = producto.fechaIngreso?.toDate();

                const ventasFiltradas = datosVentas.filter(v => v.sku === sku);
                const conteosFiltrados = datosConteo.filter(c => c.sku === sku);
                
                const ultimoConteo = conteosFiltrados.find(c => c.contador);
                const horaConteo = ultimoConteo?.timestamp?.toDate();
                
                const reposiciones = conteosFiltrados.filter(c => c.responsable);
                const ultimaReposicion = reposiciones.length > 0 ? reposiciones[0].timestamp?.toDate() : null;

                const totalVendido = ventasFiltradas.reduce((s, v) => s + v.cantidad, 0);
                const ultimaVenta = ventasFiltradas.length > 0 ? ventasFiltradas[0].timestamp?.toDate() : null;

                let fisicoContado = 0;
                let stockFinal;
                let diferenciaConteo = 'N/A';

                if (horaConteo) {
                    const lastModIndex = conteosFiltrados.findIndex(c => c.tipo === 'modificacion');
                    let stockBase = 0;
                    if (lastModIndex !== -1) {
                        stockBase = conteosFiltrados[lastModIndex].cantidad;
                        for (let i = lastModIndex + 1; i < conteosFiltrados.length; i++) {
                            if (conteosFiltrados[i].tipo === 'conteo') stockBase += conteosFiltrados[i].cantidad;
                        }
                    } else {
                        stockBase = conteosFiltrados.filter(c => c.tipo === 'conteo' && !c.responsable).reduce((s, c) => s + c.cantidad, 0);
                    }
                    fisicoContado = stockBase;
                    
                    const movimientosPostConteo = [
                        ...ventasFiltradas.map(v => ({ ...v, cantidad: -v.cantidad })),
                        ...reposiciones.map(r => ({ ...r, cantidad: r.cantidad }))
                    ].filter(m => m.timestamp && m.timestamp.toDate() > horaConteo);

                    const ajustePostConteo = movimientosPostConteo.reduce((sum, mov) => sum + mov.cantidad, 0);
                    
                    stockFinal = fisicoContado + ajustePostConteo;
                    diferenciaConteo = fisicoContado - stockTeoricoInicial;

                } else {
                    const reposicionesTeoricas = reposiciones.reduce((s, r) => s + r.cantidad, 0);
                    stockFinal = (stockTeoricoInicial + reposicionesTeoricas) - totalVendido;
                }

                let estadoCalculado, prioridad;
                if (!horaConteo) { estadoCalculado = 'Pendiente'; prioridad = 3; } 
                else if (diferenciaConteo === 0) { estadoCalculado = 'Cuadrado'; prioridad = 4; }
                else if (diferenciaConteo > 0) { estadoCalculado = 'Sobrante'; prioridad = 2; }
                else { estadoCalculado = 'Faltante'; prioridad = 1; }

                return { ...producto, stockTeorico: stockTeoricoInicial, fisicoContado, totalVendido, horaConteo, fechaIngresoTeorico, fechaUltimaRepo: ultimaReposicion, horaVenta: ultimaVenta, diferenciaConteo, stockFinal, estadoCalculado, prioridad, contador: ultimoConteo?.contador || 'N/A' };
            });
            if (searchTerm) motorCalculos = motorCalculos.filter(item => item.sku.includes(searchTerm));
            motorCalculos.sort((a, b) => { if (a.prioridad !== b.prioridad) return a.prioridad - b.prioridad; if (typeof a.diferenciaConteo === 'number' && typeof b.diferenciaConteo === 'number') return Math.abs(b.diferenciaConteo) - Math.abs(a.diferenciaConteo); return 0; });
            return motorCalculos;
        }

        const formatFecha = (f) => !f ? 'N/A' : f.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        function renderDashboard(data) {
            let rows = '';
            data.forEach(item => {
                const diffClass = item.diferenciaConteo < 0 ? 'text-red-600' : (item.diferenciaConteo > 0 ? 'text-green-600' : '');
                rows += `<tr><td class="table-cell font-bold text-center">${item.prioridad}</td><td class="table-cell font-semibold text-indigo-700">${item.sku}</td><td class="table-cell"><span class="badge badge-${item.estadoCalculado.toLowerCase()}">${item.estadoCalculado}</span></td><td class="table-cell font-bold text-lg text-blue-800">${item.stockFinal}</td><td class="table-cell font-semibold ${diffClass}">${item.diferenciaConteo}</td><td class="table-cell">${item.horaConteo ? item.fisicoContado : 'N/A'}</td><td class="table-cell">${item.stockTeorico}</td><td class="table-cell">${item.totalVendido}</td><td class="table-cell text-teal-700 font-medium">${item.contador}</td><td class="table-cell text-sm">${formatFecha(item.fechaIngresoTeorico)}</td><td class="table-cell text-sm">${formatFecha(item.fechaUltimaRepo)}</td><td class="table-cell text-sm">${formatFecha(item.horaConteo)}</td><td class="table-cell text-sm">${formatFecha(item.horaVenta)}</td></tr>`;
            });
            dashboardBody.innerHTML = rows;
        }
        
        function renderLastCounted() {
            const countedSkus = {};
            datosConteo.forEach(c => { if (c.contador && (!countedSkus[c.sku] || c.timestamp.toMillis() > countedSkus[c.sku].timestamp.toMillis())) { countedSkus[c.sku] = c; } });
            const last10 = Object.values(countedSkus).sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis()).slice(0, 10);
            lastCountedBody.innerHTML = last10.map(item => `<tr><td class="table-cell font-semibold">${item.sku}</td><td class="table-cell">${item.contador}</td><td class="table-cell">${formatFecha(item.timestamp.toDate())}</td></tr>`).join('');
        }

        function renderMovementHistory() {
            const formatFechaHora = (f) => !f ? 'N/A' : f.toLocaleString('es-AR', { hour: '2-digit', minute: '2-digit' });
            const ventas = datosVentas.map(v => ({ ...v, tipoMov: v.cantidad > 0 ? 'Venta' : 'Anulación', user: v.userEmail || v.userId, cantidad: v.cantidad > 0 ? -v.cantidad : v.cantidad }));
            const conteos = datosConteo.map(c => ({ ...c, tipoMov: c.tipo === 'modificacion' ? 'Corrección' : (c.responsable ? 'Reposición' : 'Conteo'), user: c.userEmail || c.userId }));
            const todos = [...ventas, ...conteos].sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis()).slice(0, 10);
            return todos.length === 0 ? '<li class="text-gray-500">No hay movimientos.</li>' : todos.map(mov => {
                const color = mov.cantidad < 0 ? 'text-red-600' : 'text-green-600';
                const signo = mov.cantidad > 0 ? '+' : '';
                return `<li><div class="flex-grow"><p class="font-bold text-gray-800">${mov.tipoMov}: <span class="text-indigo-600">${mov.sku}</span></p><p class="text-sm text-gray-500">Por: ${mov.responsable || mov.contador || mov.user.substring(0, 20)}</p></div><div class="text-right"><p class="font-bold text-lg ${color}">${signo}${mov.cantidad}</p><p class="text-xs text-gray-400">${formatFechaHora(mov.timestamp?.toDate())}</p></div></li>`;
            }).join('');
        }
        
        function renderAdminLog() {
            const selectedDate = logDatePicker.valueAsDate;
            const formatFull = (f) => !f ? 'N/A' : f.toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'medium' });
            const ventas = datosVentas.map(v => ({ ...v, tipoMov: v.cantidad > 0 ? 'Venta' : 'Anulación', user: v.userEmail || v.userId, cantidad: v.cantidad > 0 ? -v.cantidad : v.cantidad }));
            const conteos = datosConteo.map(c => ({ ...c, tipoMov: c.tipo === 'modificacion' ? 'Corrección' : (c.responsable ? 'Reposición' : 'Conteo'), user: c.userEmail || c.userId }));
            let todos = [...ventas, ...conteos].sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
            if (selectedDate) {
                todos = todos.filter(m => m.timestamp && m.timestamp.toDate().toDateString() === selectedDate.toDateString());
            }
            adminLogBody.innerHTML = todos.map(mov => `<tr><td class="table-cell">${formatFull(mov.timestamp?.toDate())}</td><td class="table-cell">${mov.tipoMov}</td><td class="table-cell font-semibold">${mov.sku}</td><td class="table-cell ${mov.cantidad < 0 ? 'text-red-600' : 'text-green-600'}">${mov.cantidad}</td><td class="table-cell">${mov.responsable || mov.contador || mov.user.substring(0,20)}</td></tr>`).join('');
        }
        
        function sendToAudit(logData) { fetch(GOOGLE_SCRIPT_URL_AUDIT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(logData) }).catch(err => console.error("Error en auditoría:", err)); }

        document.getElementById('btn-login').addEventListener('click', async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); showToast('Sesión iniciada.'); } catch (e) { showModal('Credenciales incorrectas.'); } });
        document.getElementById('btn-register').addEventListener('click', async () => { try { const cred = await createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value); await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, businessId: BUSINESS_ID, createdAt: serverTimestamp() }); showToast('Usuario registrado.'); } catch (e) { showModal('Error al registrar. El email ya podría estar en uso.'); } });
        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
        btnGuardarContador.addEventListener('click', () => { const n = contadorNombreInput.value.trim(); if (n) { nombreContador = n; contadorDisplay.textContent = n; showToast(`Contador fijado: ${n}`); } else { showModal('Ingrese un nombre válido.'); } });
        formVentas.addEventListener('submit', async (e) => { e.preventDefault(); const sku = normalizarSku(document.getElementById('venta-sku').value); if (!stockTeorico.some(p => p.sku === sku)) return showModal('SKU no encontrado.'); await addDoc(datosVentasCol, { timestamp: serverTimestamp(), sku, cantidad: parseInt(document.getElementById('venta-cantidad').value, 10), userId, userEmail, businessId: BUSINESS_ID }); showToast('Venta registrada.'); e.target.reset(); });
        formConteo.addEventListener('submit', async (e) => { e.preventDefault(); if (nombreContador === 'N/A') return showModal('Fije un nombre de contador primero.'); const sku = normalizarSku(document.getElementById('conteo-sku').value); if (!stockTeorico.some(p => p.sku === sku)) return showModal('SKU no encontrado.'); await addDoc(datosConteoCol, { timestamp: serverTimestamp(), sku, cantidad: parseInt(document.getElementById('conteo-cantidad').value, 10), tipo: 'conteo', userId, userEmail, contador: nombreContador, businessId: BUSINESS_ID }); showToast('Conteo añadido.'); e.target.reset(); });
        
        formCorreccionAdmin.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (document.getElementById('correc-codigo').value !== ADMIN_PASSWORD) return showModal('Código de autorización incorrecto.');
            const sku = normalizarSku(document.getElementById('correc-sku').value);
            const email = document.getElementById('correc-email').value.trim();
            if (!email) return showModal('Debe ingresar un email para auditoría.');
            if (!stockTeorico.some(p => p.sku === sku)) return showModal('SKU no encontrado.');
            
            const data = { timestamp: serverTimestamp(), sku, cantidad: parseInt(document.getElementById('correc-cantidad').value, 10), tipo: 'modificacion', userId, userEmail: email, contador: `Admin (${email})`, businessId: BUSINESS_ID };
            await addDoc(datosConteoCol, data);
            sendToAudit({ ...data, tipo: 'Corrección Stock', timestamp: new Date().toISOString() });
            showToast('Stock corregido.');
            e.target.reset();
        });

        formAnulacion.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (document.getElementById('anular-codigo').value !== ADMIN_PASSWORD) return showModal('Código de autorización incorrecto.');
            const sku = normalizarSku(document.getElementById('anular-sku').value);
            const email = document.getElementById('anular-email').value.trim();
            if (!email) return showModal('Debe ingresar un email para auditoría.');
            if (!stockTeorico.some(p => p.sku === sku)) return showModal('SKU no encontrado.');

            const data = { timestamp: serverTimestamp(), sku, cantidad: -parseInt(document.getElementById('anular-cantidad').value, 10), userId, userEmail: email, businessId: BUSINESS_ID };
            await addDoc(datosVentasCol, data);
            sendToAudit({ tipo: 'Anulación Venta', sku, cantidad: data.cantidad, responsable: email, timestamp: new Date().toISOString() });
            showToast('Venta anulada.');
            e.target.reset();
        });

        formReposicionCsv.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (document.getElementById('repo-codigo').value !== ADMIN_PASSWORD) return showModal('Código de autorización incorrecto.');
            const email = document.getElementById('repo-email').value.trim();
            if (!email) return showModal('Debe ingresar un email para auditoría.');
            const file = document.getElementById('repo-csv-input').files[0];
            if (!file) return showModal('Debe seleccionar un archivo CSV.');

            showToast('Procesando archivo de reposición...');
            const text = await file.text();
            const rows = text.split('\n').map(row => row.split(';').map(col => col.trim()));
            if (rows.length === 0) return showModal('Archivo CSV vacío o con formato no reconocido.');
            
            const batch = writeBatch(db);
            let processedCount = 0;
            rows.forEach(cols => {
                if (cols.length < 2) return;
                const sku = normalizarSku(cols[0]);
                const cantidad = parseInt(cols[1], 10);
                if (!sku || isNaN(cantidad) || !stockTeorico.some(p => p.sku === sku)) return;
                
                const data = { timestamp: serverTimestamp(), sku, cantidad, tipo: 'conteo', responsable: `CSV-${email}`, userId, userEmail: email, businessId: BUSINESS_ID };
                const docRef = doc(datosConteoCol);
                batch.set(docRef, data);
                processedCount++;
            });
            await batch.commit();
            showModal(`Reposición desde CSV cargada con ${processedCount} registros.`);
            e.target.reset();
        });

        document.getElementById('csv-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return; showToast('Procesando catálogo...');
            const text = await file.text(); const rows = text.split('\n').map(row => row.split(';').map(col => col.trim()));
            if (rows.length === 0) return showModal('Archivo CSV vacío.');
            const batch = writeBatch(db); let processedCount = 0;
            rows.forEach(cols => {
                if (cols.length < 3) return;
                const sku = normalizarSku(cols[0]); const stock = parseInt(cols[2], 10);
                if (!sku || isNaN(stock)) return;
                const docRef = doc(stockTeoricoCol); 
                batch.set(docRef, { sku, descripcion: cols[1], stock, fechaIngreso: serverTimestamp() });
                processedCount++;
            });
            await batch.commit(); showModal(`Catálogo cargado con ${processedCount} productos.`); e.target.value = '';
        });

        document.getElementById('btn-descargar-csv').addEventListener('click', () => {
            const data = getDashboardData();
            const headers = ["Prioridad", "SKU", "Descripción", "Estado", "Stock Final", "Dif. Conteo", "Físico Contado", "Stock Teórico", "Total Vendido", "Contado por", "Fecha Ing. Teórico", "Fecha Últ. Repo.", "Fecha Conteo", "Fecha Venta"];
            let csvContent = headers.join(";") + "\n";
            data.forEach(item => {
                const desc = `"${(item.descripcion || '').replace(/"/g, '""')}"`;
                const row = [item.prioridad, item.sku, desc, item.estadoCalculado, item.stockFinal, item.diferenciaConteo, item.horaConteo ? item.fisicoContado : 'N/A', item.stockTeorico, item.totalVendido, item.contador, formatFecha(item.fechaIngresoTeorico), formatFecha(item.fechaUltimaRepo), formatFecha(item.horaConteo), formatFecha(item.horaVenta)];
                csvContent += row.join(";") + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute("download", `balance_inventario_${BUSINESS_ID}.csv`);
            link.click();
        });
        document.getElementById('btn-limpiar-datos').addEventListener('click', () => {
            showPasswordModal('Limpiar todos los datos (IRREVERSIBLE)', (password) => {
                if (password === ADMIN_PASSWORD) {
                     showModalConInput(
                        '¡ADVERTENCIA! ACCIÓN IRREVERSIBLE',
                        'Esto borrará de forma PERMANENTE todo el catálogo, ventas y conteos para este negocio. Esta acción no se puede deshacer.',
                        'BORRAR DATOS',
                        async () => {
                            showToast('Eliminando datos...');
                            try {
                                const colecciones = [stockTeoricoCol, datosVentasCol, datosConteoCol];
                                for (const coleccion of colecciones) {
                                    const snapshot = await getDocs(coleccion);
                                    if (snapshot.empty) continue;
                                    const batch = writeBatch(db);
                                    snapshot.forEach(doc => batch.delete(doc.ref));
                                    await batch.commit();
                                }
                                showToast('¡Todos los datos del negocio han sido eliminados!');
                            } catch (error) {
                                showModal(`Ocurrió un error al eliminar los datos. Revisa la consola.`);
                            }
                        }
                    );
                } else {
                    showToast('Contraseña incorrecta.', true);
                }
            });
        });
        searchInput.addEventListener('input', () => { const data = getDashboardData(); renderDashboard(data); });
        btnAbrirLogAdmin.addEventListener('click', () => {
            showPasswordModal('Acceso de Administrador de Logs', (password) => {
                if (password === LOG_PASSWORD) {
                    logDatePicker.valueAsDate = new Date();
                    renderAdminLog();
                    adminLogModal.style.display = 'flex';
                } else {
                    showToast('Contraseña incorrecta.', true);
                }
            });
        });
        logDatePicker.addEventListener('change', renderAdminLog);

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sasi Smart Group PPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Paleta de Colores Pastel Femenina y Profesional */
        :root {
            --bg-main: #FDF8FA;      /* Rosa muy claro */
            --bg-card: #FFFFFF;
            --primary: #EAB3A8;      /* Rosa pastel principal */
            --primary-hover: #D69A8F; /* Rosa pastel más oscuro */
            --secondary: #E5E7EB;
            --secondary-hover: #D1D5DB;
            --text-dark: #4B4B4B;    /* Gris oscuro suave */
            --text-light: #6B7280;
            --border-color: #F3E8EB;
            --danger: #FCA5A5;        /* Rojo coral suave */
            --danger-hover: #EF4444;
            --success: #A7F3D0;      /* Menta */
            --warning: #FDE68A;      /* Amarillo pastel */
            --info: #A5B4FC;        /* Lavanda */
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        .card { background-color: var(--bg-card); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .table-header th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; background-color: var(--bg-main); position: sticky; top: 0; z-index: 10; }
        .table-cell { padding: 0.75rem 1rem; font-size: 0.875rem; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
        .badge-faltante { background-color: var(--danger); color: #B91C1C; }
        .badge-sobrante { background-color: var(--success); color: #065F46; }
        .badge-cuadrado { background-color: var(--info); color: #3730A3; }
        .badge-pendiente { background-color: var(--warning); color: #92400E; }
        .badge-no-en-catalogo { background-color: #9CA3AF; color: #1F2937; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn:disabled { background-color: #D1D5DB; cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger); color: #B91C1C; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); color: white; }
        .btn-secondary { background-color: var(--secondary); color: #374151; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: #fff; }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px #FBCFE8; }
        .input-field.invalid { border-color: var(--danger); box-shadow: 0 0 0 2px #FECACA; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); width: 90%; max-width: 1024px; text-align: left; }
        #auth-section { display: flex; flex-direction: column; gap: 1rem; padding: 2rem; background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); max-width: 400px; margin: 50px auto; }
        #app-content { display: none; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 0.5rem; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        #toast.error { background-color: var(--danger); color: #B91C1C; }
        #toast.success { background-color: var(--success); color: #065F46; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Animación para resaltar cambios en el dashboard */
        @keyframes flash-yellow {
            from { background-color: #FDE68A; } /* Amarillo pastel */
            to { background-color: transparent; }
        }
        .flash-yellow {
            animation: flash-yellow 1.5s ease-out;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8 flex flex-col min-h-screen">

    <main class="flex-grow">
        <div class="max-w-screen-2xl mx-auto">
            <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
                <div><h1 class="text-3xl font-bold">Sasi Smart Group PPS</h1></div>
                <div class="flex items-center gap-4">
                    <div class="text-gray-600">Usuario: <span id="user-id-display" class="font-semibold" style="color: var(--primary-hover);">Cargando...</span></div>
                    <div class="text-gray-600">Contador: <span id="contador-display" class="font-semibold text-teal-700">N/A</span></div>
                    <button id="btn-limpiar-datos" class="btn btn-danger"><i class="fa-solid fa-bomb"></i>Limpiar Datos</button>
                    <button id="btn-logout" class="btn btn-secondary"><i class="fa-solid fa-right-from-bracket"></i>Salir</button>
                </div>
            </header>

            <div id="auth-section">
                <h2 class="text-2xl font-bold text-center">Iniciar Sesión</h2>
                <p class="text-sm text-gray-500 text-center">Usa un email (puede ser inventado) para crear o acceder a tu espacio de trabajo.</p>
                <input type="email" id="auth-email" class="input-field" placeholder="Email del espacio de trabajo" required>
                <input type="password" id="auth-password" class="input-field" placeholder="Contraseña" required>
                <button id="btn-login" class="btn btn-primary w-full">Iniciar Sesión</button>
                <button id="btn-register" class="btn btn-secondary w-full">Crear Nuevo Espacio</button>
            </div>

            <div id="app-content">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="card"><h2 class="text-xl font-semibold mb-4">1. Sesión de Conteo</h2><div class="space-y-4"><input type="text" id="contador-nombre" class="input-field" placeholder="Nombre de quien cuenta"><button id="btn-guardar-contador" class="btn btn-primary w-full"><i class="fa-solid fa-user-check"></i>Fijar Nombre</button></div></div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4">2. Cargar Catálogo (CSV)</h2><input type="file" id="csv-file-input" accept=".csv" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100"><p class="text-sm text-gray-500 mt-2">Formato: SKU;Stock</p></div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4">3. Registrar Venta</h2><form id="form-ventas"><div class="space-y-4"><input type="text" id="venta-sku" class="input-field sku-input" placeholder="SKU del Producto" required><div class="text-xs text-red-400 hidden sku-warning">¡Ojo! Los códigos no llevan espacios.</div><input type="number" id="venta-cantidad" class="input-field" placeholder="Cantidad Vendida" required min="1"><button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-cart-shopping"></i>Registrar</button></div></form></div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4">4. Añadir a Conteo Físico</h2><form id="form-conteo"><div class="space-y-4"><input type="text" id="conteo-sku" class="input-field sku-input" placeholder="SKU del Producto" required><div class="text-xs text-red-400 hidden sku-warning">¡Ojo! Los códigos no llevan espacios.</div><input type="number" id="conteo-cantidad" class="input-field" placeholder="Cantidad a AÑADIR" required min="1"><button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-plus"></i>Añadir</button></div></form></div>
                </div>

                <div class="card border-2" style="border-color: var(--primary);" >
                    <h2 class="text-xl font-semibold mb-4"><i class="fa-solid fa-user-shield"></i> Operaciones de Administrador</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                        <form id="form-correccion-admin">
                            <h3 class="font-semibold text-lg mb-2"><i class="fa-solid fa-pen-to-square"></i> Corregir Stock Físico</h3>
                            <div class="space-y-3">
                                <input type="text" id="correc-sku" class="input-field sku-input" placeholder="SKU a corregir" required>
                                <div class="text-xs text-red-400 hidden sku-warning">¡Ojo! Los códigos no llevan espacios.</div>
                                <input type="number" id="correc-cantidad" class="input-field" placeholder="Nuevo Stock Físico TOTAL" required min="0">
                                <input type="text" id="correc-nombre-admin" class="input-field" placeholder="Su Nombre para auditoría" required>
                                <button type="submit" class="btn btn-primary w-full">Corregir</button>
                            </div>
                        </form>
                           <form id="form-anulacion">
                            <h3 class="font-semibold text-lg mb-2"><i class="fa-solid fa-undo"></i> Anular Venta</h3>
                            <div class="space-y-3">
                                <input type="text" id="anular-sku" class="input-field sku-input" placeholder="SKU de la venta a anular" required>
                                <div class="text-xs text-red-400 hidden sku-warning">¡Ojo! Los códigos no llevan espacios.</div>
                                <input type="number" id="anular-cantidad" class="input-field" placeholder="Cantidad a anular" required min="1">
                                <input type="text" id="anular-nombre-admin" class="input-field" placeholder="Su Nombre para auditoría" required>
                                <button type="submit" class="btn btn-primary w-full">Anular</button>
                            </div>
                        </form>
                        <form id="form-reposicion-csv">
                            <h3 class="font-semibold text-lg mb-2"><i class="fa-solid fa-truck-ramp-box"></i> Reponer Stock (CSV)</h3>
                            <div class="space-y-3">
                                <input type="file" id="repo-csv-input" accept=".csv" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100" required>
                                <input type="text" id="repo-nombre-admin" class="input-field" placeholder="Su Nombre para auditoría" required>
                                <p class="text-xs text-gray-500 mt-1">Formato: SKU;Cantidad</p>
                                <button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-dolly"></i>Cargar Reposición</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-8">
                    <div class="card xl:col-span-2">
                        <h2 class="text-2xl font-bold mb-4">Últimos 10 Movimientos</h2>
                        <div class="overflow-x-auto max-h-[250px]"><table class="w-full"><thead class="table-header"><tr><th>Tipo</th><th>SKU</th><th>Cantidad</th><th>Responsable</th><th>Fecha y Hora</th></tr></thead><tbody id="last-movements-body"></tbody></table></div>
                    </div>
                    <div class="card"><h2 class="text-xl font-semibold mb-4"><i class="fa-solid fa-book"></i> Log de Auditoría</h2><p class="text-gray-400 mb-4">Ver todos los movimientos registrados.</p><button id="btn-abrir-log-admin" class="btn btn-secondary w-full">Abrir Log</button></div>
                </div>

                <div class="card mt-6">
                    <div class="flex justify-between items-center mb-4 gap-4 flex-wrap"><h2 class="text-2xl font-bold">Dashboard de Reconciliación</h2><div class="flex gap-4 items-center"><input type="text" id="search-input" placeholder="Buscar por SKU..." class="input-field w-full max-w-xs"><button id="btn-descargar-csv" class="btn btn-secondary"><i class="fa-solid fa-file-csv"></i>Descargar CSV</button></div></div>
                    <div class="overflow-x-auto max-h-[65vh]">
                        <table class="w-full">
                            <thead class="table-header">
                                <tr>
                                    <th>SKU</th>
                                    <th>Estado</th>
                                    <th>Físico Proyectado</th>
                                    <th>Dif. (Histórica)</th>
                                    <th>Físico Contado</th>
                                    <th>Teórico (al Contar)</th>
                                    <th>Teórico (Actual)</th>
                                    <th>Total Vendido</th>
                                    <th>Contado por</th>
                                    <th>Fecha Conteo</th>
                                    <th>Fecha Venta</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center p-4 text-gray-500 text-sm mt-auto">
            <p>By Mor</p>
        </footer>
    </main>

    <div id="toast"></div>
    <div id="myModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><div id="modal-message" class="text-lg font-semibold mb-4"></div><div id="modal-buttons" class="flex justify-end gap-4"></div></div></div>
    <div id="adminLogModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-admin-log">&times;</span>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Log de Movimientos de Auditoría</h2>
                <button id="btn-limpiar-log" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Limpiar Log</button>
            </div>
            <div class="mb-4">
                <label for="log-date-picker" class="block text-sm font-medium mb-1">Filtrar por Fecha:</label>
                <input type="date" id="log-date-picker" class="input-field w-full max-w-xs">
            </div>
            <div class="overflow-x-auto max-h-[70vh]">
                <table class="w-full">
                    <thead class="table-header"><tr><th>Fecha y Hora</th><th>Tipo</th><th>SKU</th><th>Cantidad</th><th>Responsable</th><th>Detalle</th></tr></thead>
                    <tbody id="admin-log-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAzGc3KVQFYIoQ7W_WZAj585AbUpiU5HUI",
            authDomain: "sasi-alfa-store-pps.firebaseapp.com",
            projectId: "sasi-alfa-store-pps",
            storageBucket: "sasi-alfa-store-pps.firebasestorage.app",
            messagingSenderId: "739926676625",
            appId: "1:739926676625:web:b4ff509e304f980ff71b30"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, query, orderBy, serverTimestamp, writeBatch, getDocs, getDoc, where, updateDoc, runTransaction, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- CONSTANTES GLOBALES Y DE CONFIGURACIÓN ---
        let BUSINESS_ID = null; 
        const ADMIN_PASSWORD = '10234567';
        const LOG_PASSWORD = 'Acces0r10s@lf@';

        // --- ESTADO DE LA APLICACIÓN ---
        let theoreticalStock = [], salesData = [], countData = [], auditLog = [];
        let userId = null, userEmail = null;
        let counterName = 'N/A';
        let unsubscribes = [];

        // --- SELECCIÓN DE ELEMENTOS DEL DOM ---
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const counterDisplay = document.getElementById('contador-display');
        const btnLogout = document.getElementById('btn-logout');
        const btnClearData = document.getElementById('btn-limpiar-datos');
        const btnLogin = document.getElementById('btn-login');
        const btnRegister = document.getElementById('btn-register');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const counterNameInput = document.getElementById('contador-nombre');
        const btnSaveCounterName = document.getElementById('btn-guardar-contador');
        const csvFileInput = document.getElementById('csv-file-input');
        const formSales = document.getElementById('form-ventas');
        const salesSkuInput = document.getElementById('venta-sku');
        const salesQuantityInput = document.getElementById('venta-cantidad');
        const formCount = document.getElementById('form-conteo');
        const countSkuInput = document.getElementById('conteo-sku');
        const countQuantityInput = document.getElementById('conteo-cantidad');
        const formCorrectionAdmin = document.getElementById('form-correccion-admin');
        const correctionSkuInput = document.getElementById('correc-sku');
        const correctionQuantityInput = document.getElementById('correc-cantidad');
        const correctionAdminNameInput = document.getElementById('correc-nombre-admin');
        const formCancellation = document.getElementById('form-anulacion');
        const cancellationSkuInput = document.getElementById('anular-sku');
        const cancellationQuantityInput = document.getElementById('anular-cantidad');
        const cancellationAdminNameInput = document.getElementById('anular-nombre-admin');
        const formReposicionCsv = document.getElementById('form-reposicion-csv');
        const repoCsvInput = document.getElementById('repo-csv-input');
        const repoAdminNameInput = document.getElementById('repo-nombre-admin');
        const dashboardBody = document.getElementById('dashboard-body');
        const lastMovementsBody = document.getElementById('last-movements-body');
        const searchInput = document.getElementById('search-input');
        const btnDownloadCsv = document.getElementById('btn-descargar-csv');
        const btnOpenAdminLog = document.getElementById('btn-abrir-log-admin');
        const adminLogModal = document.getElementById('adminLogModal');
        const closeAdminLogBtn = document.getElementById('close-admin-log');
        const adminLogBody = document.getElementById('admin-log-body');
        const btnClearLog = document.getElementById('btn-limpiar-log');
        const logDatePicker = document.getElementById('log-date-picker');
        const myModal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        // --- FUNCIONES DE UTILIDAD ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = isError ? 'show error' : 'show success';
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }

        function showModal(message, isConfirm = false, onConfirm = null) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Cerrar';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.onclick = () => myModal.style.display = 'none';
            modalButtons.appendChild(closeBtn);

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.className = 'btn btn-danger';
                confirmBtn.onclick = () => {
                    onConfirm();
                    myModal.style.display = 'none';
                };
                modalButtons.appendChild(confirmBtn);
            }
            myModal.style.display = 'flex';
        }
        
        /**
         * Muestra un modal para solicitar una contraseña de forma segura.
         * @returns {Promise<string>} Una promesa que se resuelve con la contraseña si el usuario confirma,
         * o se resuelve con null si el usuario cancela.
         */
        function requestPassword() {
            return new Promise((resolve, reject) => {
                // Prepara el contenido del modal para pedir la contraseña
                modalMessage.innerHTML = `
                    <label for="modal-password-input" class="block text-sm font-medium mb-2">Se requiere contraseña de Administrador:</label>
                    <input type="password" id="modal-password-input" class="input-field" autocomplete="current-password">
                `;
                modalButtons.innerHTML = ''; // Limpia botones anteriores

                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.className = 'btn btn-primary';

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancelar';
                cancelBtn.className = 'btn btn-secondary';

                // Función para cuando se confirma
                const handleConfirm = () => {
                    const passwordInput = document.getElementById('modal-password-input');
                    myModal.style.display = 'none';
                    resolve(passwordInput.value); // Devuelve la contraseña escrita
                };
                
                // Función para cuando se cancela
                const handleCancel = () => {
                    myModal.style.display = 'none';
                    resolve(null); // Resolvemos con null para poder manejar la cancelación
                };
                
                confirmBtn.onclick = handleConfirm;
                cancelBtn.onclick = handleCancel;
                
                // Permite confirmar con la tecla Enter
                const passwordInput = modalMessage.querySelector('#modal-password-input');
                passwordInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirm();
                    }
                });

                modalButtons.appendChild(cancelBtn);
                modalButtons.appendChild(confirmBtn);
                myModal.style.display = 'flex';
                passwordInput.focus(); // Pone el cursor en el campo de contraseña
            });
        }
        
        function downloadCsv(filename, data) {
            const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleButton(button, enable) {
            button.disabled = !enable;
            if (enable) {
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString('es-AR');
        }

        function validateSku(sku) {
            const skuRegex = /^[A-Z0-9_-]+$/;
            if (!sku) return false;
            if (!skuRegex.test(sku)) return false;
            return true;
        }

        function setupSkuInputValidation() {
            const skuInputs = document.querySelectorAll('.sku-input');
            skuInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const originalValue = e.target.value;
                    e.target.value = originalValue.trim();
                    const warningMessage = e.target.nextElementSibling;
                    if (e.target.value.includes(' ')) {
                        input.classList.add('invalid');
                        if (warningMessage && warningMessage.classList.contains('sku-warning')) {
                            warningMessage.textContent = "¡Ojo! Los códigos no llevan espacios.";
                            warningMessage.classList.remove('hidden');
                        }
                    } else if (!validateSku(e.target.value.toUpperCase())) {
                        input.classList.add('invalid');
                        if (warningMessage && warningMessage.classList.contains('sku-warning')) {
                            warningMessage.textContent = "SKU inválido. Solo letras, números, guiones y guiones bajos permitidos.";
                            warningMessage.classList.remove('hidden');
                        }
                    } else {
                        input.classList.remove('invalid');
                        if (warningMessage && warningMessage.classList.contains('sku-warning')) {
                            warningMessage.classList.add('hidden');
                            warningMessage.textContent = "¡Ojo! Los códigos no llevan espacios.";
                        }
                    }
                });
            });
        }

        function setCountingModuleState(enabled) {
            const form = document.getElementById('form-conteo');
            const card = form.closest('.card');
            const inputs = form.querySelectorAll('input');
            const button = form.querySelector('button');

            if (enabled) {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
                inputs.forEach(input => input.disabled = false);
                button.disabled = false;
            } else {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
                inputs.forEach(input => input.disabled = true);
                button.disabled = true;
            }
        }

        // --- LÓGICA DE FIREBASE Y SINCRONIZACIÓN ---
        function startFirestoreListeners() {
            if (!BUSINESS_ID) return;
            
            // Suscribirse al stock teórico (catálogo)
            unsubscribes.push(onSnapshot(collection(db, `businesses/${BUSINESS_ID}/theoreticalStock`), (snapshot) => {
                theoreticalStock = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                debouncedRender();
            }));

            // Suscribirse a los datos de ventas
            unsubscribes.push(onSnapshot(collection(db, `businesses/${BUSINESS_ID}/salesData`), (snapshot) => {
                salesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                debouncedRender();
            }));

            // Suscribirse a los datos de conteo
            unsubscribes.push(onSnapshot(collection(db, `businesses/${BUSINESS_ID}/countData`), (snapshot) => {
                countData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                debouncedRender();
            }));

            // El listener de auditLog no afecta al dashboard principal, así que puede quedar como está
            const auditQuery = query(collection(db, `businesses/${BUSINESS_ID}/auditLog`), orderBy('timestamp', 'desc'), limit(10));
            unsubscribes.push(onSnapshot(auditQuery, (snapshot) => {
                auditLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLastMovements();
            }));
        }

        function stopFirestoreListeners() {
            unsubscribes.forEach(unsubscribe => unsubscribe());
            unsubscribes = [];
        }
        
        async function logAction(type, sku, quantity, responsible, detail) {
            if (!BUSINESS_ID) return;
            const logCol = collection(db, `businesses/${BUSINESS_ID}/auditLog`);
            await addDoc(logCol, {
                type,
                sku: sku.toUpperCase(),
                quantity,
                responsible,
                detail,
                timestamp: serverTimestamp()
            });
        }
        
        // --- LÓGICA DE CÁLCULO Y RENDERIZADO DEL DASHBOARD ---

        // Función para evitar múltiples renders en ráfagas de cambios
        const debouncedRender = debounce(renderDashboard, 150);

        // --- Utilidades ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function normalizeSku(sku) {
            if (typeof sku !== 'string') return null;
            const trimmed = sku.trim().toUpperCase();
            if (!trimmed) return null;
            if (!/^[A-Z0-9_-]+$/.test(trimmed)) return null;
            return trimmed;
        }

        const timestampCache = new WeakMap();
        function toDateCached(timestamp) {
            if (!timestamp) return null;
            if (timestampCache.has(timestamp)) return timestampCache.get(timestamp);
            try {
                const date = timestamp.toDate();
                timestampCache.set(timestamp, date);
                return date;
            } catch {
                return null;
            }
        }

        function safeSumQuantities(items) {
            return items.reduce((sum, item) => {
                const qty = Number(item.quantity);
                return sum + (isNaN(qty) ? 0 : qty);
            }, 0);
        }

        function daysBetween(date1, date2) {
            if (!(date1 instanceof Date) || !(date2 instanceof Date)) return null;
            const diffMs = Math.abs(date2 - date1);
            return diffMs / (1000 * 60 * 60 * 24);
        }

        // --- Clase SkuData enriquecida ---

        class SkuData {
            constructor(sku) {
                this.sku = sku;
                this.ventas = [];
                this.conteos = [];
                this.errors = [];
            }

            addVenta(venta) {
                if (!venta || typeof venta.quantity !== 'number' || isNaN(venta.quantity)) {
                    this.errors.push(`Venta inválida para SKU ${this.sku}: cantidad inválida.`);
                    return;
                }
                if (!venta.timestamp || typeof venta.timestamp.toDate !== 'function') {
                    this.errors.push(`Venta sin timestamp válido para SKU ${this.sku}.`);
                    return;
                }
                if (venta.quantity === 0) return; // Ignorar ventas con cantidad cero
                this.ventas.push(venta);
            }

            addConteo(conteo) {
                if (!conteo || typeof conteo.quantity !== 'number' || isNaN(conteo.quantity)) {
                    this.errors.push(`Conteo inválido para SKU ${this.sku}: cantidad inválida.`);
                    return;
                }
                if (!conteo.timestamp || typeof conteo.timestamp.toDate !== 'function') {
                    this.errors.push(`Conteo sin timestamp válido para SKU ${this.sku}.`);
                    return;
                }
                if (conteo.quantity === 0) return; // Ignorar conteos con cantidad cero
                this.conteos.push(conteo);
            }

            getLatestConteo() {
                if (this.conteos.length === 0) return null;
                return this.conteos.reduce((a, b) => {
                    const dateA = toDateCached(a.timestamp);
                    const dateB = toDateCached(b.timestamp);
                    if (!dateA) return b;
                    if (!dateB) return a;
                    return dateA > dateB ? a : b;
                });
            }

            getVentaMasReciente() {
                if (this.ventas.length === 0) return null;
                return this.ventas.reduce((a, b) => {
                    const dateA = toDateCached(a.timestamp);
                    const dateB = toDateCached(b.timestamp);
                    if (!dateA) return b;
                    if (!dateB) return a;
                    return dateA > dateB ? a : b;
                });
            }

            getFechaPrimeraVenta() {
                if (this.ventas.length === 0) return null;
                return this.ventas.reduce((a, b) => {
                    const dateA = toDateCached(a.timestamp);
                    const dateB = toDateCached(b.timestamp);
                    if (!dateA) return b;
                    if (!dateB) return a;
                    return dateA < dateB ? a : b;
                }).timestamp;
            }

            getVelocidadDeVenta() {
                const primeraVenta = toDateCached(this.getFechaPrimeraVenta());
                const ultimaVenta = toDateCached(this.getVentaMasReciente()?.timestamp);
                if (!primeraVenta || !ultimaVenta) return null;

                const totalVendido = safeSumQuantities(this.ventas);
                if (totalVendido === 0) return 0;
                
                const dias = daysBetween(primeraVenta, ultimaVenta);
                if (!dias || dias === 0) return null;

                return totalVendido / dias;
            }

            getDiasDesdeUltimoConteo() {
                const ultimoConteo = this.getLatestConteo();
                if (!ultimoConteo) return null;
                const fechaConteo = toDateCached(ultimoConteo.timestamp);
                if (!fechaConteo) return null;
                const hoy = new Date();
                return Math.floor(daysBetween(fechaConteo, hoy));
            }

            calcularEstado(stock_teorico_inicial) {
                stock_teorico_inicial = Number(stock_teorico_inicial);
                if (isNaN(stock_teorico_inicial) || stock_teorico_inicial < 0) {
                    this.errors.push(`Stock teórico inicial inválido para SKU ${this.sku}. Se usará 0.`);
                    stock_teorico_inicial = 0;
                }

                const ventasValidas = this.ventas.filter(v => {
                    const qty = Number(v.quantity);
                    return !isNaN(qty) && qty !== 0 && v.timestamp && typeof v.timestamp.toDate === 'function';
                });

                const total_vendido = safeSumQuantities(ventasValidas);
                const stock_teorico_actual = stock_teorico_inicial - total_vendido;

                const conteo = this.getLatestConteo();

                let conteo_fisico = 0;
                let fecha_conteo = null;
                let diferencia_historica = null;
                let stock_teorico_al_contar = null;

                if (conteo) {
                    conteo_fisico = Number(conteo.quantity);
                    fecha_conteo = toDateCached(conteo.timestamp);

                    if (!fecha_conteo) {
                        this.errors.push(`Timestamp inválido en conteo para SKU ${this.sku}.`);
                    } else {
                        const ventasAntesConteo = ventasValidas.filter(v => toDateCached(v.timestamp) < fecha_conteo);
                        const total_vendido_antes = safeSumQuantities(ventasAntesConteo);

                        stock_teorico_al_contar = stock_teorico_inicial - total_vendido_antes;
                        diferencia_historica = conteo_fisico - stock_teorico_al_contar;
                    }
                }

                const stock_fisico_proyectado = (diferencia_historica !== null) ? (stock_teorico_actual + diferencia_historica) : null;

                let estado = 'Pendiente';
                if (diferencia_historica !== null) {
                    if (diferencia_historica === 0) estado = 'Cuadrado';
                    else if (diferencia_historica > 0) estado = 'Sobrante';
                    else if (diferencia_historica < 0) estado = 'Faltante';
                }

                const lastSale = this.getVentaMasReciente();

                return {
                    sku: this.sku,
                    estado,
                    conteo_fisico,
                    stock_teorico_al_contar,
                    diferencia_historica,
                    stock_teorico_actual,
                    stock_fisico_proyectado,
                    total_vendido,
                    fecha_conteo,
                    theoreticalDate: null,
                    saleDate: lastSale ? toDateCached(lastSale.timestamp) : null,
                    counter: conteo ? (conteo.counter || 'N/A') : 'N/A',
                    errors: [...this.errors],
                    fechaPrimeraVenta: toDateCached(this.getFechaPrimeraVenta()),
                    velocidadDeVenta: this.getVelocidadDeVenta(),
                    diasDesdeUltimoConteo: this.getDiasDesdeUltimoConteo()
                };
            }
        }

        // --- Memoización y cache global ---

        const memoCache = {
            lastSalesData: null,
            lastCountData: null,
            lastTheoreticalStock: null,
            cachedDashboardData: null
        };

        function deepEqual(a, b) {
            // Implementa una comparación profunda simple o usa una librería como lodash.isEqual
            // Aquí un ejemplo simple para arrays y objetos planos:
            try {
                return JSON.stringify(a) === JSON.stringify(b);
            } catch {
                return false;
            }
        }

        /**
         * Función principal con memoización.
         * Solo recalcula dashboardData si cambian los datos base.
         * El filtro de búsqueda se aplica sobre el resultado cacheado.
         */
        function getDashboardData() {
            const searchTerm = (searchInput.value || '').trim().toUpperCase();

            // Verificar si los datos base cambiaron
            const salesChanged = !deepEqual(salesData, memoCache.lastSalesData);
            const countChanged = !deepEqual(countData, memoCache.lastCountData);
            const stockChanged = !deepEqual(theoreticalStock, memoCache.lastTheoreticalStock);

            if (salesChanged || countChanged || stockChanged || !memoCache.cachedDashboardData) {
                // Actualizar cache base
                memoCache.lastSalesData = JSON.parse(JSON.stringify(salesData));
                memoCache.lastCountData = JSON.parse(JSON.stringify(countData));
                memoCache.lastTheoreticalStock = JSON.parse(JSON.stringify(theoreticalStock));

                // Construir mapa SKU
                const skuMap = new Map();

                for (const sale of salesData) {
                    const sku = normalizeSku(sale.sku);
                    if (!sku) continue;
                    if (!skuMap.has(sku)) skuMap.set(sku, new SkuData(sku));
                    skuMap.get(sku).addVenta(sale);
                }

                for (const count of countData) {
                    if (count.type !== 'conteo') continue;
                    const sku = normalizeSku(count.sku);
                    if (!sku) continue;
                    if (!skuMap.has(sku)) skuMap.set(sku, new SkuData(sku));
                    skuMap.get(sku).addConteo(count);
                }

                const dashboardData = [];

                for (const product of theoreticalStock) {
                    const sku = normalizeSku(product.sku);
                    if (!sku) continue;

                    const skuData = skuMap.get(sku) || new SkuData(sku);
                    if (product.errors) skuData.errors.push(...product.errors);

                    const resultado = skuData.calcularEstado(product.stock);
                    resultado.theoreticalDate = toDateCached(product.timestamp);

                    dashboardData.push(resultado);
                    skuMap.delete(sku);
                }

                for (const [sku, skuData] of skuMap.entries()) {
                    const resultado = skuData.calcularEstado(0);
                    resultado.estado = 'No en Catálogo';
                    resultado.theoreticalDate = null;
                    dashboardData.push(resultado);
                }

                memoCache.cachedDashboardData = dashboardData;
            }

            // Aplicar filtro de búsqueda sobre cache
            let filtered = memoCache.cachedDashboardData;
            if (searchTerm) {
                filtered = filtered.filter(d => d.sku.includes(searchTerm));
            }

            // Ordenar
            const prioridadEstado = {
                'Faltante': 1,
                'Sobrante': 2,
                'Pendiente': 3,
                'Cuadrado': 4,
                'No en Catálogo': 5
            };

            filtered.sort((a, b) => {
                const pA = prioridadEstado[a.estado] || 99;
                const pB = prioridadEstado[b.estado] || 99;
                if (pA !== pB) return pA - pB;
                return a.sku.localeCompare(b.sku);
            });

            // Actualizar UI con alertas visuales y log global de errores
            mostrarAlertasYLogErrores(filtered);

            return filtered;
        }

        // --- Función para mostrar alertas visuales y log global de errores ---

        function mostrarAlertasYLogErrores(dashboardData) {
            dashboardData.forEach(item => {
                const rowElement = document.querySelector(`[data-sku="${item.sku}"]`);
                if (!rowElement) return;
                
                const skuCell = rowElement.querySelector('.sku-cell');
                if (!skuCell) return;

                const existingAlert = skuCell.querySelector('.error-alert');
                if (existingAlert) existingAlert.remove();

                if (item.errors && item.errors.length > 0) {
                    const alertIcon = document.createElement('span');
                    alertIcon.className = 'error-alert';
                    alertIcon.textContent = ' ⚠️'; // Espacio inicial para separar del SKU
                    alertIcon.title = item.errors.join('\n');
                    alertIcon.style.cursor = 'help';
                    skuCell.appendChild(alertIcon);
                }
            });
            // Opcional: Implementar un log global en la UI si se considera necesario
        }
        
        // REEMPLAZA TU FUNCIÓN renderDashboard() COMPLETA CON ESTA NUEVA VERSIÓN:
        function renderDashboard() {
            // Obtenemos el estado anterior del dashboard desde el cache antes de calcular el nuevo
            const oldDataMap = new Map(memoCache.cachedDashboardData?.map(item => [item.sku, item]));

            const data = getDashboardData(); // getDashboardData ahora se encarga de todo el cálculo y cacheo
            dashboardBody.innerHTML = '';

            if (data.length === 0) {
                dashboardBody.innerHTML = `<tr><td colspan="11" class="table-cell text-center">No hay datos para mostrar.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const badgeClass = `badge badge-${item.estado.toLowerCase().replace(/ /g, '-')}`;
                const row = document.createElement('tr');
                row.dataset.sku = item.sku;

                // Comparamos el estado actual con el anterior
                const oldItem = oldDataMap.get(item.sku);
                if (!oldItem || oldItem.estado !== item.estado) {
                    // Si el item es nuevo o su estado cambió, aplicamos la animación
                    row.classList.add('flash-yellow');
                }

                row.innerHTML = `
                    <td class="table-cell font-semibold sku-cell">${item.sku}</td>
                    <td class="table-cell"><span class="${badgeClass}">${item.estado}</span></td>
                    <td class="table-cell text-right font-bold text-blue-600">${item.stock_fisico_proyectado !== null ? item.stock_fisico_proyectado : 'N/A'}</td>
                    <td class="table-cell text-right font-bold">${item.diferencia_historica !== null ? item.diferencia_historica : 'N/A'}</td>
                    <td class="table-cell text-right">${item.conteo_fisico}</td>
                    <td class="table-cell text-right">${item.stock_teorico_al_contar !== null ? item.stock_teorico_al_contar : 'N/A'}</td>
                    <td class="table-cell text-right">${item.stock_teorico_actual}</td>
                    <td class="table-cell text-right">${item.total_vendido}</td>
                    <td class="table-cell">${item.counter}</td>
                    <td class="table-cell">${formatFirebaseTimestamp(item.fecha_conteo)}</td>
                    <td class="table-cell">${formatFirebaseTimestamp(item.saleDate)}</td>
                `;
                dashboardBody.appendChild(row);
            });
            
            // La llamada a mostrarAlertasYLogErrores ya está dentro de getDashboardData,
            // así que no necesitamos llamarla de nuevo aquí.
        }
        
        function renderLastMovements() {
            lastMovementsBody.innerHTML = '';
            if (auditLog.length === 0) {
                lastMovementsBody.innerHTML = `<tr><td colspan="5" class="table-cell text-center">No hay movimientos recientes.</td></tr>`;
                return;
            }
            auditLog.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="table-cell">${log.type}</td>
                    <td class="table-cell">${log.sku}</td>
                    <td class="table-cell text-right">${log.quantity}</td>
                    <td class="table-cell">${log.responsible}</td>
                    <td class="table-cell">${formatFirebaseTimestamp(log.timestamp)}</td>
                `;
                lastMovementsBody.appendChild(row);
            });
        }
        
        // --- LISTENERS DE LA INTERFAZ DE USUARIO ---
        
        // Autenticación
        btnLogin.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            toggleButton(btnLogin, false);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast("Error de autenticación. Verifica email y contraseña.", true);
                console.error(error);
            } finally {
                toggleButton(btnLogin, true);
            }
        });

        btnRegister.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            toggleButton(btnRegister, false);
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Espacio creado exitosamente. ¡Bienvenido!", false);
            } catch (error) {
                showToast("Error al crear espacio. Intenta con otro email.", true);
                console.error(error);
            } finally {
                toggleButton(btnRegister, true);
            }
        });

        btnLogout.addEventListener('click', async () => {
            toggleButton(btnLogout, false);
            await signOut(auth);
            toggleButton(btnLogout, true);
        });

        // Configuración de contador
        btnSaveCounterName.addEventListener('click', () => {
            if (counterNameInput.disabled) {
                // --- MODO "CAMBIAR NOMBRE" ---
                counterNameInput.disabled = false;
                counterNameInput.focus();
                btnSaveCounterName.innerHTML = '<i class="fa-solid fa-user-check"></i> Fijar Nombre';
                
                // Resetea el estado y deshabilita el módulo de conteo
                counterName = 'N/A';
                counterDisplay.textContent = counterName;
                setCountingModuleState(false); 
                showToast('Sesión de conteo terminada. Ingrese un nuevo nombre.', false);

            } else {
                // --- MODO "FIJAR NOMBRE" ---
                const newName = counterNameInput.value.trim();
                if (newName) {
                    counterName = newName;
                    counterDisplay.textContent = counterName;
                    counterNameInput.disabled = true;
                    btnSaveCounterName.innerHTML = '<i class="fa-solid fa-pencil"></i> Cambiar Nombre';

                    // Habilita el módulo de conteo
                    setCountingModuleState(true); 
                    showToast(`Sesión de conteo iniciada para: ${counterName}`, false);
                } else {
                    showToast('Por favor, ingrese un nombre válido.', true);
                }
            }
        });
        
        // Cargar CSV (Stock Teórico)
        csvFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const text = event.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim());

                // La validación detallada se mantiene para IDENTIFICAR errores
                const allLinesData = lines.map((line, index) => {
                    const cols = line.split(';');
                    const sku = cols[0]?.trim()?.toUpperCase();
                    const stockString = cols[1]?.trim().replace(',', '.');
                    let stock = parseFloat(stockString);
                    const errors = [];

                    if (!sku) errors.push('El SKU está vacío.');
                    else {
                        if (sku.includes(' ')) errors.push('El SKU no debe contener espacios.');
                        if (!/^[A-Z0-9_-]+$/.test(sku)) errors.push('El SKU contiene caracteres no válidos.');
                    }

                    if (cols[1] === undefined || cols[1].trim() === '') errors.push('El Stock está vacío. Se asignará 0.');
                    else if (isNaN(stock)) errors.push('El Stock no es un número. Se asignará 0.');
                    else if (stock < 0) errors.push('El Stock es negativo. Se asignará 0.');
                    
                    // Sanitización: si el stock es inválido, lo forzamos a 0 para poder cargarlo.
                    if (isNaN(stock) || stock < 0) stock = 0;

                    return { sku, stock, originalLine: line, lineNumber: index + 1, errors };
                });

                const seenSkus = new Map();
                allLinesData.forEach(lineData => {
                    if (lineData.sku && !lineData.errors.some(e => e.includes('vacío') || e.includes('caracteres'))) {
                        if (seenSkus.has(lineData.sku)) {
                            lineData.errors.push(`SKU duplicado (1ra vez en línea ${seenSkus.get(lineData.sku).lineNumber}). No se cargará el stock de esta línea.`);
                            const first = seenSkus.get(lineData.sku);
                            if (!first.errors.some(e => e.startsWith('SKU duplicado'))) {
                                first.errors.push(`SKU duplicado (repetido en línea ${lineData.lineNumber}).`);
                            }
                        } else {
                            seenSkus.set(lineData.sku, lineData);
                        }
                    }
                });

                // Ahora procesamos TODAS las líneas, no solo las válidas
                const productosConAdvertencias = allLinesData.filter(item => item.errors.length > 0);
                let message = `Se procesarán ${allLinesData.length} productos.`;
                if (productosConAdvertencias.length > 0) {
                    message += ` Se detectaron ${productosConAdvertencias.length} productos con advertencias que serán marcados en el dashboard.`;
                }

                showModal(message, true, async () => {
                    const batch = writeBatch(db);
                    const stockTeoricoColRef = collection(db, `businesses/${BUSINESS_ID}/theoreticalStock`);
                    
                    const oldDocs = await getDocs(stockTeoricoColRef);
                    oldDocs.forEach(doc => batch.delete(doc.ref));

                    const skusAddedToBatch = new Set();

                    allLinesData.forEach(item => {
                        // Solo añadimos el PRIMER SKU válido para evitar duplicar stock
                        if (item.sku && !skusAddedToBatch.has(item.sku)) {
                            const newDocRef = doc(stockTeoricoColRef);
                            batch.set(newDocRef, {
                                sku: item.sku,
                                stock: item.errors.some(e => e.includes('duplicado')) ? 0 : item.stock, // Si es duplicado, su stock no suma.
                                timestamp: serverTimestamp(),
                                errors: item.errors // Guardamos los errores en la base de datos
                            });
                            skusAddedToBatch.add(item.sku);
                        }
                    });
                    
                    try {
                        await batch.commit();
                        let successMessage = `Catálogo cargado con ${allLinesData.length} productos procesados.`;
                        if (productosConAdvertencias.length > 0) {
                            successMessage += ` Se marcaron ${productosConAdvertencias.length} con advertencias. Revisa el dashboard.`;
                            // Opcional: Aún podemos descargar el CSV de errores para un reporte separado
                            const errorCsvHeader = ['SKU_Original', 'Stock_Original', 'Motivo_del_Error'];
                            const errorCsvRows = productosConAdvertencias.map(errorItem => {
                                const originalCols = errorItem.originalLine.split(';');
                                const errorReason = errorItem.errors.join('; ');
                                return [
                                    `"${originalCols[0]?.trim() || ''}"`,
                                    `"${originalCols[1]?.trim() || ''}"`,
                                    `"${errorReason}"`
                                ];
                            });
                            const errorCsvContent = [
                                errorCsvHeader.join(';'),
                                ...errorCsvRows.map(row => row.join(';'))
                            ].join('\n');
                            downloadCsv(`advertencias_catalogo_${new Date().toISOString()}.csv`, errorCsvContent);
                        }
                        showToast(successMessage, false);
                        await logAction('Catálogo', 'N/A', allLinesData.length, userEmail, `Cargado con ${productosConAdvertencias.length} advertencias.`);
                        e.target.value = '';
                    } catch (error) {
                        showToast("Error crítico al cargar el catálogo.", true);
                        console.error(error);
                    }
                });
            };
            reader.onerror = () => showToast("Error leyendo el archivo CSV.", true);
            reader.readAsText(file);
        });
        
        // Registrar Venta
        formSales.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sku = salesSkuInput.value.trim().toUpperCase();
            const quantity = Number(salesQuantityInput.value);
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (!validateSku(sku)) {
                salesSkuInput.classList.add('invalid');
                showToast("SKU inválido.", true);
                return;
            } else {
                salesSkuInput.classList.remove('invalid');
            }
            if (!quantity || quantity <= 0) {
                salesQuantityInput.classList.add('invalid');
                showToast("Cantidad debe ser mayor que cero.", true);
                return;
            } else {
                salesQuantityInput.classList.remove('invalid');
            }

            toggleButton(submitButton, false);
            try {
                await addDoc(collection(db, `businesses/${BUSINESS_ID}/salesData`), {
                    sku,
                    quantity,
                    timestamp: serverTimestamp()
                });
                await logAction('Venta', sku, quantity, 'N/A', `Vendido ${quantity} unidades.`);
                showToast("Venta registrada con éxito.", false);
                formSales.reset();
                salesSkuInput.focus();
            } catch (error) {
                showToast("Error al registrar venta.", true);
                console.error(error);
            } finally {
                toggleButton(submitButton, true);
            }
        });
        
        // Añadir Conteo Físico
        formCount.addEventListener('submit', async (e) => {
            e.preventDefault();
            const skuInput = countSkuInput;
            const quantityInput = countQuantityInput;
            const sku = skuInput.value.trim().toUpperCase();
            const quantity = Number(quantityInput.value);
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (counterName === 'N/A') {
                showToast("Por favor, fije un nombre de contador primero.", true);
                return;
            }
            if (!validateSku(sku)) {
                skuInput.classList.add('invalid');
                showToast("SKU inválido.", true);
                return;
            } else {
                skuInput.classList.remove('invalid');
            }
            if (!quantity || quantity <= 0) {
                quantityInput.classList.add('invalid');
                showToast("Cantidad debe ser mayor que cero.", true);
                return;
            } else {
                quantityInput.classList.remove('invalid');
            }

            const originalButtonText = submitButton.textContent;
            toggleButton(submitButton, false);
            submitButton.textContent = 'Añadiendo...';
            showToast("Aún no se ha guardado el producto, espera un momento.", false);

            try {
                const countColRef = collection(db, `businesses/${BUSINESS_ID}/countData`);
                const q = query(countColRef, where("sku", "==", sku), where("type", "==", "conteo"));
                
                await runTransaction(db, async (transaction) => {
                    const countSnapshot = await getDocs(q);
                    
                    if (countSnapshot.empty) {
                        const newCountRef = doc(countColRef);
                        transaction.set(newCountRef, {
                            sku,
                            quantity,
                            type: 'conteo',
                            counter: counterName,
                            timestamp: serverTimestamp()
                        });
                    } else {
                        const existingDoc = countSnapshot.docs[0];
                        const existingData = existingDoc.data();
                        const newTotal = (existingData.quantity || 0) + quantity;
                        transaction.update(existingDoc.ref, { 
                            quantity: newTotal,
                            counter: counterName, 
                            timestamp: serverTimestamp()
                        });
                    }
                });
                
                await logAction('Conteo Físico', sku, quantity, counterName, `Añadidas ${quantity} unidades.`);
                showToast("Conteo actualizado con éxito.", false);
                formCount.reset();
                countSkuInput.focus();
            } catch (error) {
                showToast("Error al actualizar conteo.", true);
                console.error("Error en transacción de conteo:", error);
            } finally {
                toggleButton(submitButton, true);
                submitButton.textContent = originalButtonText;
            }
        });
        
        // Búsqueda en el Dashboard
        searchInput.addEventListener('input', renderDashboard);
        
        // Descargar CSV
        btnDownloadCsv.addEventListener('click', () => {
            const data = getDashboardData();
            if (data.length === 0) {
                showToast("No hay datos para descargar.", true);
                return;
            }

            const header = ['Prioridad', 'SKU', 'Estado', 'Físico Proyectado', 'Dif. (Histórica)', 'Físico Contado', 'Teórico (al Contar)', 'Teórico (Actual)', 'Total Vendido', 'Contado por', 'Fecha Conteo', 'Fecha Venta'];
            const rows = data.map(item => [
                item.sku,
                item.estado,
                item.stock_fisico_proyectado !== null ? item.stock_fisico_proyectado : 'N/A',
                item.diferencia_historica !== null ? item.diferencia_historica : 'N/A',
                item.conteo_fisico,
                item.stock_teorico_al_contar !== null ? item.stock_teorico_al_contar : 'N/A',
                item.stock_teorico_actual,
                item.total_vendido,
                `"${item.counter}"`,
                item.fecha_conteo ? item.fecha_conteo.toISOString() : 'N/A',
                item.saleDate ? item.saleDate.toISOString() : 'N/A'
            ]);
            
            const csvContent = [
                header.join(';'),
                ...rows.map(e => e.join(';'))
            ].join('\n');
            
            downloadCsv(`dashboard_sasi_${new Date().toISOString()}.csv`, csvContent);
            showToast("CSV descargado con éxito.", false);
        });

        // Operaciones de Administrador
        formCorrectionAdmin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sku = correctionSkuInput.value.trim().toUpperCase();
            const quantity = Number(correctionQuantityInput.value);
            const name = correctionAdminNameInput.value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            if (!validateSku(sku)) {
                correctionSkuInput.classList.add('invalid');
                showToast("SKU inválido.", true);
                return;
            } else {
                correctionSkuInput.classList.remove('invalid');
            }
            if (quantity < 0 || isNaN(quantity)) {
                correctionQuantityInput.classList.add('invalid');
                showToast("Cantidad debe ser 0 o mayor.", true);
                return;
            } else {
                correctionQuantityInput.classList.remove('invalid');
            }
            if (!name) {
                correctionAdminNameInput.classList.add('invalid');
                showToast("Debe ingresar su nombre para auditoría.", true);
                return;
            } else {
                correctionAdminNameInput.classList.remove('invalid');
            }
            
            toggleButton(submitButton, false);

            try {
                const password = await requestPassword();
                if (password === ADMIN_PASSWORD) {
                    showModal(`¿Confirma la corrección de stock físico para SKU ${sku} a ${quantity}? Esta acción es irreversible.`, true, async () => {
                        try {
                            const countColRef = collection(db, `businesses/${BUSINESS_ID}/countData`);
                            const q = query(countColRef, where("sku", "==", sku), where("type", "==", "conteo"));
                            const countSnapshot = await getDocs(q);
                            
                            let oldValue = 0;
                            if (!countSnapshot.empty) {
                                const existingDoc = countSnapshot.docs[0];
                                oldValue = existingDoc.data().quantity || 0;
                                await updateDoc(existingDoc.ref, {
                                    quantity,
                                    counter: name,
                                    timestamp: serverTimestamp()
                                });
                            } else {
                                await addDoc(countColRef, {
                                    sku,
                                    quantity,
                                    type: 'conteo',
                                    counter: name,
                                    timestamp: serverTimestamp()
                                });
                            }
                            await logAction('Corrección Admin', sku, quantity, name, `Stock físico corregido de ${oldValue} a ${quantity}.`);
                            showToast("Stock físico corregido con éxito.", false);
                            formCorrectionAdmin.reset();
                        } catch (error) {
                            showToast("Error al corregir stock.", true);
                            console.error(error);
                        }
                    });
                } else if (password !== null) {
                    showToast("Contraseña incorrecta. Operación cancelada.", true);
                }
            } catch(error) {
                showToast("Operación cancelada.", true);
            } finally {
                toggleButton(submitButton, true);
            }
        });
        
        // Anular Venta
        formCancellation.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sku = cancellationSkuInput.value.trim().toUpperCase();
            const quantity = Number(cancellationQuantityInput.value);
            const name = cancellationAdminNameInput.value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (!validateSku(sku) || quantity <= 0 || isNaN(quantity) || !name) {
                showToast("Por favor, complete todos los campos correctamente.", true);
                return;
            }

            toggleButton(submitButton, false);

            try {
                const password = await requestPassword();

                if (password === ADMIN_PASSWORD) {
                    showModal(`¿Confirma la anulación de ${quantity} unidades del SKU ${sku}?`, true, async () => {
                        try {
                            await addDoc(collection(db, `businesses/${BUSINESS_ID}/salesData`), {
                                sku,
                                quantity: -quantity,
                                type: 'anulacion',
                                responsible: name,
                                timestamp: serverTimestamp()
                            });
                            await logAction('Anulación', sku, -quantity, name, `Anuladas ${quantity} unidades.`);
                            showToast("Venta anulada con éxito.", false);
                            formCancellation.reset();
                        } catch (error) {
                            showToast("Error al anular venta.", true);
                            console.error(error);
                        }
                    });
                } else {
                    showToast("Contraseña incorrecta. Operación cancelada.", true);
                }
            } catch(error) {
                showToast("Operación cancelada.", true);
            } finally {
                toggleButton(submitButton, true);
            }
        });
        
        // Reposición de Stock (CSV)
        formReposicionCsv.addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = repoCsvInput.files[0];
            const name = repoAdminNameInput.value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (!file || !name) {
                showToast("Debe seleccionar un archivo y especificar su nombre.", true);
                return;
            }
            
            toggleButton(submitButton, false);

            try {
                const password = await requestPassword(); // Usamos el nuevo modal

                if (password !== ADMIN_PASSWORD) {
                    showToast("Contraseña incorrecta. Operación cancelada.", true);
                    toggleButton(submitButton, true);
                    return;
                }

                // Si la contraseña es correcta, leemos el archivo
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const text = event.target.result;
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    
                    const dataToUpload = lines.map(line => {
                        const cols = line.split(';');
                        const sku = cols[0]?.trim()?.toUpperCase();
                        const quantity = parseInt(cols[1]?.trim());
                        if (!validateSku(sku) || isNaN(quantity) || quantity <= 0) return null;
                        return { sku, quantity };
                    }).filter(item => item !== null);

                    if (dataToUpload.length === 0) {
                        showToast("Archivo CSV vacío o con formato incorrecto.", true);
                        toggleButton(submitButton, true);
                        return;
                    }

                    const skusWithErrorsCount = lines.length - dataToUpload.length;

                    showModal(`¿Confirma la reposición de ${dataToUpload.length} SKUs? Esto AÑADIRÁ stock al catálogo teórico. Se omitieron ${skusWithErrorsCount} líneas con errores.`, true, async () => {
                        let successCount = 0;
                        let errorCount = 0;
                        
                        // LÓGICA CORRECTA: Actualiza el stock teórico
                        for (const item of dataToUpload) {
                            const stockColRef = collection(db, `businesses/${BUSINESS_ID}/theoreticalStock`);
                            try {
                                await runTransaction(db, async (transaction) => {
                                    const q = query(stockColRef, where('sku', '==', item.sku));
                                    const theoreticalStockSnapshot = await transaction.get(q);

                                    if (theoreticalStockSnapshot.empty) {
                                        // Si el producto no existe, lo crea
                                        transaction.set(doc(stockColRef), {
                                            sku: item.sku,
                                            stock: item.quantity,
                                            timestamp: serverTimestamp()
                                        });
                                    } else {
                                        // Si existe, actualiza el stock
                                        const existingDoc = theoreticalStockSnapshot.docs[0];
                                        const newStock = (existingDoc.data().stock || 0) + item.quantity;
                                        transaction.update(existingDoc.ref, { stock: newStock });
                                    }
                                });
                                await logAction('Reposición', item.sku, item.quantity, name, `Repuestas ${item.quantity} unidades.`);
                                successCount++;
                            } catch (error) {
                                console.error(`Error al reponer SKU ${item.sku}:`, error);
                                errorCount++;
                            }
                        }
                        
                        showToast(`Reposición completada. Éxito: ${successCount}, Errores: ${errorCount}.`, errorCount > 0);
                        formReposicionCsv.reset();
                    });
                };
                reader.onerror = () => {
                    showToast("Error leyendo el archivo CSV.", true);
                    toggleButton(submitButton, true);
                };
                reader.readAsText(file);

            } catch (error) {
                // Esto se ejecuta si el usuario cancela el modal de contraseña
                showToast("Operación cancelada.", true);
            } finally {
                toggleButton(submitButton, true);
            }
        });

        // Log de Auditoría
        btnOpenAdminLog.addEventListener('click', async () => {
            try {
                const password = await requestPassword();
                if (password === LOG_PASSWORD) {
                    adminLogModal.style.display = 'flex';
                    const allLogsQuery = query(collection(db, `businesses/${BUSINESS_ID}/auditLog`), orderBy('timestamp', 'desc'));
                    const logsSnapshot = await getDocs(allLogsQuery);
                    const allLogs = logsSnapshot.docs.map(doc => doc.data());
                    renderAdminLog(allLogs);
                } else if (password !== null) {
                    showToast("Contraseña incorrecta.", true);
                }
            } catch (error) {
                showToast("Operación cancelada.", true);
            }
        });

        closeAdminLogBtn.addEventListener('click', () => {
            adminLogModal.style.display = 'none';
        });

        function renderAdminLog(logs) {
            adminLogBody.innerHTML = '';
            if (logs.length === 0) {
                adminLogBody.innerHTML = `<tr><td colspan="6" class="table-cell text-center">No hay registros de auditoría.</td></tr>`;
                return;
            }
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="table-cell">${formatFirebaseTimestamp(log.timestamp)}</td>
                    <td class="table-cell">${log.type}</td>
                    <td class="table-cell">${log.sku}</td>
                    <td class="table-cell text-right">${log.quantity}</td>
                    <td class="table-cell">${log.responsible}</td>
                    <td class="table-cell">${log.detail}</td>
                `;
                adminLogBody.appendChild(row);
            });
        }

        btnClearLog.addEventListener('click', async () => {
            try {
                const password = await requestPassword();
                if (password === ADMIN_PASSWORD) {
                    showModal('¿Está seguro de que desea limpiar todo el Log de Auditoría? Esta acción es irreversible.', true, async () => {
                        try {
                            const logsColRef = collection(db, `businesses/${BUSINESS_ID}/auditLog`);
                            const logsSnapshot = await getDocs(logsColRef);
                            const batch = writeBatch(db);
                            logsSnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            showToast("Log de auditoría limpiado con éxito.", false);
                        } catch (error) {
                            showToast("Error al limpiar el log.", true);
                            console.error(error);
                        }
                    });
                } else if (password !== null) {
                    showToast("Contraseña incorrecta. Operación cancelada.", true);
                }
            } catch (error) {
                showToast("Operación cancelada.", true);
            }
        });

        logDatePicker.addEventListener('change', async (e) => {
            const selectedDate = e.target.value;
            if (selectedDate) {
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);
                
                const q = query(collection(db, `businesses/${BUSINESS_ID}/auditLog`), orderBy('timestamp', 'desc'), where('timestamp', '>=', startOfDay), where('timestamp', '<=', endOfDay));
                const logsSnapshot = await getDocs(q);
                const filteredLogs = logsSnapshot.docs.map(doc => doc.data());
                renderAdminLog(filteredLogs);
            } else {
                const allLogsQuery = query(collection(db, `businesses/${BUSINESS_ID}/auditLog`), orderBy('timestamp', 'desc'));
                const logsSnapshot = await getDocs(allLogsQuery);
                const allLogs = logsSnapshot.docs.map(doc => doc.data());
                renderAdminLog(allLogs);
            }
        });
        
        btnClearData.addEventListener('click', async () => {
            try {
                const password = await requestPassword();
                if (password === ADMIN_PASSWORD) {
                    showModal('¡ATENCIÓN! ¿Desea eliminar todos los datos operativos (stock, ventas, conteos)? El Log de Auditoría NO se borrará. Esta acción es irreversible.', true, async () => {
                        const collectionsToClear = ['theoreticalStock', 'salesData', 'countData'];
                        try {
                            for (const colName of collectionsToClear) {
                                const colRef = collection(db, `businesses/${BUSINESS_ID}/${colName}`);
                                const docs = await getDocs(colRef);
                                const batch = writeBatch(db);
                                docs.forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                            }
                            await logAction('Limpieza de Datos', 'SISTEMA', 0, userEmail, 'Se eliminaron todos los datos operativos.');
                            showToast("Todos los datos del negocio han sido eliminados.", false);
                        } catch (error) {
                            showToast("Error al limpiar los datos.", true);
                            console.error("Error al limpiar datos del negocio:", error);
                        }
                    });
                } else if (password !== null) {
                    showToast("Contraseña incorrecta. Operación cancelada.", true);
                }
            } catch (error) {
                showToast("Operación cancelada.", true);
            }
        });
        
        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                userEmail = user.email;
                BUSINESS_ID = user.email;
                userIdDisplay.textContent = userEmail;
                authSection.style.display = 'none';
                appContent.style.display = 'block';
                stopFirestoreListeners();
                startFirestoreListeners();
            } else {
                userId = null;
                userEmail = null;
                BUSINESS_ID = null;
                userIdDisplay.textContent = 'No autenticado';
                authSection.style.display = 'flex';
                appContent.style.display = 'none';
                stopFirestoreListeners();
                theoreticalStock = [];
                salesData = [];
                countData = [];
                auditLog = [];
                renderDashboard();
                renderLastMovements();
            }
        });
        
        // Llamada inicial para configurar la validación de los inputs
        setupSkuInputValidation();
        // Deshabilitar el módulo de conteo por defecto al cargar la app
        setCountingModuleState(false);
    </script>
</body>
</html>

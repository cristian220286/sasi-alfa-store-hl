<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sasi Alfa Store HL - Enterprise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); width: 90%; max-width: 1024px; text-align: left; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
    #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 0.5rem; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 17px; }
    #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    #toast.error { background-color: #dc2626; }
    #toast.success { background-color: #16a34a; }
    @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    .btn {
        @apply font-medium py-2 px-4 rounded-md transition-colors duration-200 ease-in-out;
    }
    .btn-primary {
        @apply bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2;
    }
    .btn-secondary {
        @apply bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2;
    }
    .btn-danger {
        @apply bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
    }
    .btn-sm {
        @apply py-1 px-2 text-sm;
    }
    .btn:disabled {
        @apply opacity-50 cursor-not-allowed;
    }
    .input-field {
        @apply block px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 focus:outline-none focus:ring;
    }
    .card {
        @apply bg-white rounded-lg shadow-md p-6;
    }
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-8 flex flex-col min-h-screen">

  <div id="toast"></div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc">
    <div class="modal-content">
      <span id="modal-close" class="close-button" role="button" tabindex="0" aria-label="Cerrar">&times;</span>
      <h2 id="modal-title" class="text-xl font-semibold mb-4"></h2>
      <div id="modal-desc" class="mb-4"></div>
      <div id="modal-buttons" class="flex justify-end gap-4"></div>
    </div>
  </div>

  <div id="scanner-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="scanner-title" aria-describedby="scanner-desc">
    <div class="modal-content max-w-md">
      <span id="scanner-close" class="close-button" role="button" tabindex="0" aria-label="Cerrar escáner">&times;</span>
      <h2 id="scanner-title" class="text-xl font-semibold mb-4">Escanear SKU</h2>
      <div id="scanner-desc" class="mb-4">Apunte la cámara al código de barras o QR.</div>
      <div id="qr-reader" class="w-full h-64"></div>
      <button id="manual-entry-btn" class="btn btn-secondary mt-4 w-full">Ingresar Manualmente</button>
    </div>
  </div>

  <main class="flex-grow max-w-screen-2xl mx-auto">
    <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
      <h1 class="text-3xl font-bold text-gray-800">Sasi Alfa Store HL - Enterprise</h1>
      <div class="flex items-center gap-4">
        <div class="text-gray-600">Usuario: <span id="user-id-display" class="font-semibold text-indigo-700">Cargando...</span></div>
        <button id="btn-logout" class="btn btn-secondary" aria-label="Cerrar sesión"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
      </div>
    </header>

    <section id="auth-section" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md flex flex-col gap-4">
      <h2 class="text-2xl font-bold text-center text-gray-700">Iniciar Sesión</h2>
      <input type="email" id="auth-email" class="input-field" placeholder="Correo Electrónico" required autocomplete="username" />
      <input type="password" id="auth-password" class="input-field" placeholder="Contraseña" required autocomplete="current-password" />
      <button id="btn-login" class="btn btn-primary">Iniciar Sesión</button>
      <button id="btn-register" class="btn btn-secondary">Registrarse</button>
      <p class="text-sm text-gray-500 text-center mt-2">Si no tienes cuenta, se creará una al registrarte.</p>
    </section>

    <section id="app-content" class="hidden space-y-8">

      <section class="card">
        <h2 class="text-2xl font-bold mb-4">Sesiones de Conteo</h2>
        <div id="session-controls" class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <button id="btn-start-session" class="btn btn-primary"><i class="fa-solid fa-play"></i> Iniciar Nueva Sesión de Conteo</button>
            <span id="active-session-info" class="ml-4 font-semibold text-teal-700"></span>
          </div>
          <div>
            <button id="btn-finish-session" class="btn btn-danger" disabled><i class="fa-solid fa-check"></i> Finalizar y Reconciliar Sesión</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 class="text-2xl font-bold mb-4">Registrar Conteo de SKU</h2>
        <form id="form-count-sku" class="flex flex-col sm:flex-row gap-4 items-center">
          <div class="flex-grow">
            <label for="count-sku" class="sr-only">SKU</label>
            <input type="text" id="count-sku" class="input-field w-full" placeholder="SKU" readonly aria-describedby="count-sku-desc" required />
            <p id="count-sku-desc" class="text-xs text-gray-500 mt-1">Use el escáner o ingrese manualmente.</p>
          </div>
          <button type="button" id="btn-scan-sku" class="btn btn-secondary flex items-center gap-2">
            <i class="fa-solid fa-camera"></i> Escanear SKU
          </button>
          <input type="number" id="count-quantity" class="input-field w-24" placeholder="Cantidad" min="1" required />
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Añadir Conteo</button>
        </form>
      </section>

      <section class="card">
        <h2 class="text-2xl font-bold mb-4">Conteos en Sesión Activa</h2>
        <div class="overflow-x-auto max-h-[50vh]">
          <table class="w-full table-auto border-collapse border border-gray-300">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="border border-gray-300 p-2 text-left">SKU</th>
                <th class="border border-gray-300 p-2 text-right">Cantidad</th>
                <th class="border border-gray-300 p-2 text-left">Última Actualización</th>
                <th class="border border-gray-300 p-2 text-left">Contado Por</th>
                <th class="border border-gray-300 p-2 text-center">Acciones</th>
              </tr>
            </thead>
            <tbody id="session-counts-body" class="overflow-y-auto"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2 class="text-2xl font-bold mb-4">Log de Auditoría</h2>
        <div class="overflow-x-auto max-h-[40vh]">
          <table class="w-full table-auto border-collapse border border-gray-300">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="border border-gray-300 p-2 text-left">Fecha y Hora</th>
                <th class="border border-gray-300 p-2 text-left">Tipo</th>
                <th class="border border-gray-300 p-2 text-left">SKU</th>
                <th class="border border-gray-300 p-2 text-right">Cantidad</th>
                <th class="border border-gray-300 p-2 text-left">Responsable</th>
                <th class="border border-gray-300 p-2 text-left">Detalle</th>
              </tr>
            </thead>
            <tbody id="audit-log-body"></tbody>
          </table>
        </div>
      </section>

    </section>
  </main>

  <footer class="text-center p-4 text-gray-500 text-sm mt-auto">By Mor - Enterprise Edition</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, getIdTokenResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, query, where, getDocs, getDoc, addDoc, updateDoc, arrayUnion, serverTimestamp, onSnapshot, runTransaction, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
    import { Html5Qrcode } from "https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAzGc3KVQFYIoQ7W_WZAj585AbUpiU5HUI",
      authDomain: "sasi-alfa-store-pps.firebaseapp.com",
      projectId: "sasi-alfa-store-pps",
      storageBucket: "sasi-alfa-store-pps.firebasestorage.app",
      messagingSenderId: "739926676625",
      appId: "1:739926676625:web:b4ff509e304f980ff71b30"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    const BUSINESS_ID = 'Sasi Alfa Store HL';

    // UI Elements
    const authSection = document.getElementById('auth-section');
    const appContent = document.getElementById('app-content');
    const userIdDisplay = document.getElementById('user-id-display');
    const btnLogout = document.getElementById('btn-logout');
    const btnLogin = document.getElementById('btn-login');
    const btnRegister = document.getElementById('btn-register');
    const inputEmail = document.getElementById('auth-email');
    const inputPassword = document.getElementById('auth-password');
    const btnStartSession = document.getElementById('btn-start-session');
    const btnFinishSession = document.getElementById('btn-finish-session');
    const activeSessionInfo = document.getElementById('active-session-info');
    const formCountSku = document.getElementById('form-count-sku');
    const inputCountSku = document.getElementById('count-sku');
    const inputCountQuantity = document.getElementById('count-quantity');
    const btnScanSku = document.getElementById('btn-scan-sku');
    const sessionCountsBody = document.getElementById('session-counts-body');
    const scannerModal = document.getElementById('scanner-modal');
    const qrReaderDiv = document.getElementById('qr-reader');
    const scannerClose = document.getElementById('scanner-close');
    const manualEntryBtn = document.getElementById('manual-entry-btn');
    const submitBtn = formCountSku.querySelector('button[type="submit"]');

    // Estado
    let currentUser = null;
    let currentRole = null;
    let currentSession = null;
    let unsubscribeCounts = null;

    // --- Utilidades UI ---
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `show ${isError ? 'error' : 'success'}`;
      setTimeout(() => {
        toast.className = toast.className.replace('show', '');
      }, 3000);
    }

    function showConfirmationModal(title, message, onConfirm, onCancel) {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const modalDesc = document.getElementById('modal-desc');
      const modalButtons = document.getElementById('modal-buttons');
      const modalClose = document.getElementById('modal-close');
      modalTitle.textContent = title;
      modalDesc.textContent = message;
      modalButtons.innerHTML = `<button id="modal-cancel" class="btn btn-secondary">Cancelar</button><button id="modal-confirm" class="btn btn-danger">Confirmar</button>`;
      modal.style.display = 'flex';
      modalClose.focus();

      function cleanup() {
        modal.style.display = 'none';
        modalButtons.querySelector('#modal-cancel').removeEventListener('click', onCancelClick);
        modalButtons.querySelector('#modal-confirm').removeEventListener('click', onConfirmClick);
        modalClose.removeEventListener('click', onCloseClick);
      }
      function onCancelClick() { cleanup(); if (onCancel) onCancel(); }
      function onConfirmClick() { cleanup(); if (onConfirm) onConfirm(); }
      function onCloseClick() { cleanup(); if (onCancel) onCancel(); }

      modalButtons.querySelector('#modal-cancel').addEventListener('click', onCancelClick);
      modalButtons.querySelector('#modal-confirm').addEventListener('click', onConfirmClick);
      modalClose.addEventListener('click', onCloseClick);
    }

    // Función para manejar el estado de los botones (deshabilitar/habilitar)
    function toggleButtonState(button, isLoading = false, originalText = null) {
      if (isLoading) {
        button.disabled = true;
        button.textContent = 'Cargando...';
      } else {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    // Manejo de la tecla Escape para cerrar modales
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('modal');
        const scannerModal = document.getElementById('scanner-modal');
        if (modal.style.display === 'flex') {
          showConfirmationModal('Cancelar', '¿Desea cancelar la operación?', () => {}, () => {});
        } else if (scannerModal.style.display === 'flex') {
          document.getElementById('scanner-close').click();
        }
      }
    });

    // --- Firebase Auth ---
    async function login(email, password) {
      await signInWithEmailAndPassword(auth, email, password);
    }
    async function register(email, password) {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      const userDocRef = doc(db, "users", user.uid);
      await setDoc(userDocRef, { email: user.email, businessId: BUSINESS_ID, role: "operator" });
    }
    async function logout() {
      await signOut(auth);
    }

    // --- Cloud Functions ---
    async function callFunction(functionName, data = {}) {
      const fn = httpsCallable(functions, functionName);
      try {
        const result = await fn(data);
        return result.data;
      } catch (error) {
        throw error;
      }
    }
    async function finalizeSession(sessionId) {
      return callFunction('reconcileCountSession', { sessionId });
    }

    // --- Firestore Sessions ---
    async function getActiveSession() {
      const sessionsCol = collection(db, 'sessions');
      const q = query(sessionsCol, where('businessId', '==', BUSINESS_ID), where('status', '==', 'active'));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return null;
      return { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
    }
    async function createSession(userUid) {
      const active = await getActiveSession();
      if (active) throw new Error('Ya existe una sesión activa.');
      const sessionsCol = collection(db, 'sessions');
      const docRef = await addDoc(sessionsCol, {
        businessId: BUSINESS_ID,
        status: 'active',
        startedAt: serverTimestamp(),
        startedBy: userUid,
        completedAt: null,
        summary: { uniqueSkusCounted: 0, totalItemsCounted: 0, discrepanciesFound: 0 }
      });
      return { id: docRef.id };
    }
    function listenCounts(sessionId, callback) {
      const countsCol = collection(db, `sessions/${sessionId}/counts`);
      return onSnapshot(countsCol, snapshot => {
        const counts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(counts);
      });
    }

    async function upsertCount(sessionId, sku, quantity, userUid, mode = 'add') {
      const countDocRef = doc(db, `sessions/${sessionId}/counts`, sku);
      await runTransaction(db, async (transaction) => {
        const countDoc = await transaction.get(countDocRef);
        const now = serverTimestamp();
        if (!countDoc.exists()) {
          transaction.set(countDocRef, {
            sku,
            quantity,
            countedBy: userUid,
            lastUpdatedAt: now,
            history: [{ timestamp: now, countedBy: userUid, quantity }]
          });
        } else {
          const data = countDoc.data();
          let newQuantity;
          if (mode === 'overwrite') {
            newQuantity = quantity;
          } else if (mode === 'add') {
            newQuantity = (data.quantity || 0) + quantity;
          } else {
            throw new Error('Modo inválido para upsertCount');
          }
          transaction.update(countDocRef, {
            quantity: newQuantity,
            countedBy: userUid,
            lastUpdatedAt: now,
            history: arrayUnion({ timestamp: now, countedBy: userUid, quantity })
          });
        }
      });
    }

    // --- Lógica Principal (Main) ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        try {
          const tokenResult = await getIdTokenResult(user, true);
          currentRole = tokenResult.claims.role || null;
        } catch {
          currentRole = null;
        }
        userIdDisplay.textContent = currentUser.email || currentUser.uid;
        authSection.style.display = 'none';
        appContent.style.display = 'block';
        await loadActiveSession();
      } else {
        currentUser = null;
        currentRole = null;
        currentSession = null;
        userIdDisplay.textContent = 'No autenticado';
        authSection.style.display = 'flex';
        appContent.style.display = 'none';
        activeSessionInfo.textContent = '';
        btnFinishSession.disabled = true;
        inputCountSku.value = '';
        inputCountQuantity.value = '';
        submitBtn.textContent = 'Añadir Conteo';
        delete submitBtn.dataset.editing;
        inputCountSku.readOnly = true;
        sessionCountsBody.innerHTML = '';
        if (unsubscribeCounts) {
          unsubscribeCounts();
          unsubscribeCounts = null;
        }
      }
    });

    btnLogin.addEventListener('click', async () => {
      const email = inputEmail.value.trim();
      const password = inputPassword.value.trim();
      if (!email || !password) {
        showToast('Email y contraseña son requeridos.', true);
        return;
      }
      toggleButtonState(btnLogin, true, 'Iniciar Sesión');
      try {
        await login(email, password);
        inputPassword.value = '';
      } catch (error) {
        showToast(`Error al iniciar sesión: ${error.message}`, true);
      } finally {
        toggleButtonState(btnLogin, false, 'Iniciar Sesión');
      }
    });

    btnRegister.addEventListener('click', async () => {
      const email = inputEmail.value.trim();
      const password = inputPassword.value.trim();
      if (!email || !password) {
        showToast('Email y contraseña son requeridos.', true);
        return;
      }
      toggleButtonState(btnRegister, true, 'Registrarse');
      try {
        await register(email, password);
        showToast('Usuario registrado con éxito.', false);
      } catch (error) {
        showToast(`Error en el registro: ${error.message}`, true);
      } finally {
        toggleButtonState(btnRegister, false, 'Registrarse');
      }
    });

    btnLogout.addEventListener('click', async () => {
      toggleButtonState(btnLogout, true, 'Salir');
      try {
        await logout();
      } catch (error) {
        showToast('Error al salir.', true);
      } finally {
        toggleButtonState(btnLogout, false, 'Salir');
      }
    });

    async function loadActiveSession() {
      try {
        currentSession = await getActiveSession();
        if (currentSession) {
          activeSessionInfo.textContent = `Sesión activa: ${currentSession.id}`;
          btnFinishSession.disabled = false;
          subscribeToCounts(currentSession.id);
        } else {
          activeSessionInfo.textContent = 'No hay sesión activa';
          btnFinishSession.disabled = true;
          sessionCountsBody.innerHTML = '';
          if (unsubscribeCounts) {
            unsubscribeCounts();
            unsubscribeCounts = null;
          }
        }
        // Limpiar formulario y estado de edición al cargar/cambiar de sesión
        inputCountSku.value = '';
        inputCountQuantity.value = '';
        submitBtn.textContent = 'Añadir Conteo';
        delete submitBtn.dataset.editing;
        inputCountSku.readOnly = true;
      } catch (error) {
        showToast('Error al cargar sesión activa.', true);
      }
    }

    btnStartSession.addEventListener('click', async () => {
      if (!currentUser) {
        showToast('Debe iniciar sesión primero.', true);
        return;
      }
      toggleButtonState(btnStartSession, true, 'Iniciar Nueva Sesión de Conteo');
      try {
        await createSession(currentUser.uid);
        showToast('Sesión iniciada con éxito.', false);
        await loadActiveSession();
      } catch (error) {
        showToast(error.message, true);
      } finally {
        toggleButtonState(btnStartSession, false, 'Iniciar Nueva Sesión de Conteo');
      }
    });

    btnFinishSession.addEventListener('click', () => {
      if (!currentSession) {
        showToast('No hay sesión activa para finalizar.', true);
        return;
      }
      showConfirmationModal(
        'Finalizar Sesión',
        '¿Está seguro que desea finalizar y reconciliar la sesión activa? Esta acción es irreversible.',
        async () => {
          toggleButtonState(btnFinishSession, true, 'Finalizar y Reconciliar Sesión');
          try {
            await finalizeSession(currentSession.id);
            showToast('Sesión finalizada y reconciliada con éxito.', false);
            await loadActiveSession();
          } catch (error) {
            showToast(`Error al finalizar sesión: ${error.message}`, true);
          } finally {
            toggleButtonState(btnFinishSession, false, 'Finalizar y Reconciliar Sesión');
          }
        },
        () => {}
      );
    });

    function subscribeToCounts(sessionId) {
      if (unsubscribeCounts) unsubscribeCounts();
      unsubscribeCounts = listenCounts(sessionId, (counts) => {
        renderCounts(counts);
      });
    }

    function renderCounts(counts) {
      if (!counts || counts.length === 0) {
        sessionCountsBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No hay conteos registrados.</td></tr>';
        return;
      }
      sessionCountsBody.innerHTML = counts.map(c => `
        <tr>
          <td class="border p-2 font-semibold">${c.sku}</td>
          <td class="border p-2 text-right">${c.quantity}</td>
          <td class="border p-2">${c.lastUpdatedAt?.toDate ? c.lastUpdatedAt.toDate().toLocaleString() : 'N/A'}</td>
          <td class="border p-2">${c.countedBy}</td>
          <td class="border p-2 text-center">
            <button class="btn btn-sm btn-primary edit-btn" data-sku="${c.sku}" aria-label="Editar conteo">Editar</button>
            <button class="btn btn-sm btn-danger delete-btn ml-2" data-sku="${c.sku}" aria-label="Eliminar conteo">Eliminar</button>
          </td>
        </tr>
      `).join('');

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => {
          const sku = btn.getAttribute('data-sku');
          startEditCount(sku);
        };
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => {
          const sku = btn.getAttribute('data-sku');
          confirmDeleteCount(sku);
        };
      });
    }

    formCountSku.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentSession) {
        showToast('No hay sesión activa.', true);
        return;
      }
      const sku = inputCountSku.value.trim().toUpperCase();
      const quantity = Number(inputCountQuantity.value);

      if (!sku || !quantity || quantity <= 0 || !Number.isInteger(quantity)) {
        showToast('SKU y cantidad (entero positivo) válidos son obligatorios.', true);
        return;
      }

      const editingSku = submitBtn.dataset.editing;
      toggleButtonState(submitBtn, true, 'Añadir Conteo');

      try {
        if (editingSku) {
          await upsertCount(currentSession.id, sku, quantity, currentUser.uid, 'overwrite');
          showToast('Conteo actualizado con éxito.', false);
          submitBtn.textContent = 'Añadir Conteo';
          delete submitBtn.dataset.editing;
          inputCountSku.readOnly = true;
          inputCountSku.value = '';
          inputCountQuantity.value = '';
        } else {
          const countDocRef = doc(db, `sessions/${currentSession.id}/counts`, sku);
          const countDoc = await getDoc(countDocRef);
          if (countDoc.exists()) {
            const existingData = countDoc.data();
            showConfirmationModal(
              'ALERTA: SKU ya contado',
              `El SKU ${sku} ya fue contado con ${existingData.quantity} unidades. ¿Desea sobrescribir la cantidad o añadir el nuevo conteo?`,
              async () => {
                try {
                  toggleButtonState(submitBtn, true, 'Añadir Conteo');
                  await upsertCount(currentSession.id, sku, quantity, currentUser.uid, 'overwrite');
                  showToast('Conteo sobrescrito con éxito.', false);
                  inputCountSku.value = '';
                  inputCountQuantity.value = '';
                  inputCountSku.readOnly = true;
                } catch (error) {
                  showToast(`Error al sobrescribir conteo: ${error.message}`, true);
                } finally {
                  toggleButtonState(submitBtn, false, 'Añadir Conteo');
                }
              },
              async () => {
                try {
                  toggleButtonState(submitBtn, true, 'Añadir Conteo');
                  await upsertCount(currentSession.id, sku, quantity, currentUser.uid, 'add');
                  showToast('Cantidad añadida con éxito.', false);
                  inputCountSku.value = '';
                  inputCountQuantity.value = '';
                  inputCountSku.readOnly = true;
                } catch (error) {
                  showToast(`Error al añadir cantidad: ${error.message}`, true);
                } finally {
                  toggleButtonState(submitBtn, false, 'Añadir Conteo');
                }
              }
            );
          } else {
            await upsertCount(currentSession.id, sku, quantity, currentUser.uid, 'add');
            showToast('Conteo añadido con éxito.', false);
            inputCountSku.value = '';
            inputCountQuantity.value = '';
            inputCountSku.readOnly = true;
          }
        }
      } catch (error) {
        showToast(`Error al procesar conteo: ${error.message}`, true);
      } finally {
        toggleButtonState(submitBtn, false, 'Añadir Conteo');
      }
    });

    async function startEditCount(sku) {
      if (!currentSession) return;
      toggleButtonState(submitBtn, true, 'Guardar Cambios');
      const countDocRef = doc(db, `sessions/${currentSession.id}/counts`, sku);
      try {
        const countDocSnap = await getDoc(countDocRef);
        if (!countDocSnap.exists()) {
          showToast('Conteo no encontrado.', true);
          return;
        }
        const data = countDocSnap.data();
        inputCountSku.value = data.sku;
        inputCountQuantity.value = data.quantity;
        inputCountSku.readOnly = true;
        inputCountQuantity.focus();
        submitBtn.textContent = 'Guardar Cambios';
        submitBtn.dataset.editing = sku;
      } finally {
        toggleButtonState(submitBtn, false, 'Guardar Cambios');
      }
    }

    function confirmDeleteCount(sku) {
      showConfirmationModal(
        'Eliminar Conteo',
        `¿Está seguro que desea eliminar el conteo del SKU ${sku}? Esta acción no se puede deshacer.`,
        async () => {
          try {
            if (!currentSession) return;
            const countDocRef = doc(db, `sessions/${currentSession.id}/counts`, sku);
            await deleteDoc(countDocRef);
            showToast('Conteo eliminado con éxito.', false);
          } catch (error) {
            showToast(`Error al eliminar conteo: ${error.message}`, true);
          }
        },
        () => {}
      );
    }

    btnScanSku.addEventListener('click', () => {
      scannerModal.style.display = 'flex';
      const html5QrCode = new Html5Qrcode("qr-reader");

      function stopScanner() {
        html5QrCode.stop().catch(() => {}).finally(() => {
          qrReaderDiv.innerHTML = '';
          scannerModal.style.display = 'none';
        });
      }

      scannerClose.onclick = () => stopScanner();
      manualEntryBtn.onclick = () => {
        stopScanner();
        inputCountSku.readOnly = false;
        inputCountSku.focus();
      };

      html5QrCode.start(
        { facingMode: "environment" }, { fps: 10, qrbox: 250 },
        (decodedText) => {
          inputCountSku.value = decodedText.toUpperCase();
          inputCountSku.readOnly = true;
          stopScanner();
        },
        () => {}
      ).catch(err => {
        showToast('Error al iniciar el escáner: ' + err, true);
        scannerModal.style.display = 'none';
      });
    });
  </script>
</body>
</html>
